---
title: 'Data Exploration: IUCN and AquaMaps'
output: html_document
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}

# Libraries and Paths

library(ggplot2)
library(readr)
library(raster)
library(rgdal)
library(tidyr)
library(dplyr)
library(stringr)

dir_M <- c('Windows' = '//mazu.nceas.ucsb.edu/ohi',
           'Darwin'  = '/Volumes/ohi',    ### connect (cmd-K) to smb://mazu/ohi
           'Linux'   = '/home/shares/ohi')[[ Sys.info()[['sysname']] ]]

dir_git <- '~/github/IUCN-AquaMaps'
  
dir_anx <- file.path(dir_M, 'git-annex/globalprep/spp_ico')
dir_fig <- file.path(dir_git, 'figures')
dir_ohi_data <- file.path(dir_git, 'case_study_ohi/ohi_global_data')

source(file.path(dir_git, 'data_explore/data_explore_fxns.R'))

```

### NOTE:

This analysis depends on data generated by the full Ocean Health Index Species goal scripts and data.  The data loaded here was output from multiple runs of that original script.

The original OHI Species goal script(s) can be found in the `github/ohi-science/ohiprep` repository; browse to the `globalprep/spp_ico/v2016` folder for the `data_prep_spp.Rmd` and supporting files, scripts, and intermediate data.

``` {r load_data_from_global_analyses}

st_base  <- read_csv(file.path(dir_ohi_data, 'spp_status_global_IUCNpref_prob0.4.csv'))
st_scen1 <- read_csv(file.path(dir_ohi_data, 'spp_status_global_IUCNpref_prob0.csv'))
st_scen2 <- read_csv(file.path(dir_ohi_data, 'spp_status_global_AMpref_prob0.4.csv'))
st_scen3 <- read_csv(file.path(dir_ohi_data, 'spp_status_global_AMpref_prob0.csv'))

### scenario 1: prefer IUCN data; drop AM probability threshold to 0.01
### scenario 2: prefer AM data; keep AM prob thresh at 0.40
### scenario 3: prefer AM data; drop AM prob thresh to 0.01

st_all <- st_base %>% rename(st_b = score) %>%
  left_join(st_scen1 %>% rename(st_1 = score), by = 'rgn_id') %>%
  left_join(st_scen2 %>% rename(st_2 = score), by = 'rgn_id') %>%
  left_join(st_scen3 %>% rename(st_3 = score), by = 'rgn_id')
  
st_all <- st_all %>% mutate(absdiff1 = (st_1 - st_b)*100,
                            absdiff2 = (st_2 - st_b)*100,
                            absdiff3 = (st_3 - st_b)*100) %>%
  gather(scenario, difference, absdiff1:absdiff3)

```


``` {r build_violin_plots}
viol_plot_global <- ggplot(data = st_all %>% filter(str_detect(scenario, 'abs')),
                    aes(x = scenario, y = difference)) +
  ggtheme_plot + 
  geom_hline(yintercept = 0, color = 'gray50', size = .5) +
  geom_violin(fill = 'grey80', alpha = .5,
              scale = 'width',
              draw_quantiles = c(.25, .5, .75)) +
  geom_point(position = position_jitter(w = .3), 
             color = 'black', alpha = 1, size = 0.25) +
  geom_violin(fill = NA, 
              draw_quantiles = c(.25, .5, .75),
              scale = 'width') +
  labs(x = 'Scenario',
       y = 'Change in SPP status') +
  scale_x_discrete(labels = c('4. IUCN/AquaMaps\nno threshold', 
                              '5. AquaMaps/IUCN\n40% threshold', 
                              '6. AquaMaps/IUCN\nno threshold'))

print(viol_plot_global)

ggsave(file.path(dir_fig, 'fig3b_boxplot_ohi_global.png'), 
       height = 4.5, width = 8.7, units = 'cm', dpi = 600)
ggsave(file.path(dir_fig, 'fig3b_boxplot_ohi_global.tif'), device = 'tiff',
       height = 4.5, width = 8.7, units = 'cm', dpi = 600)

