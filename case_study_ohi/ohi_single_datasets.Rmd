---
title: 'Data Exploration: IUCN and AquaMaps'
output: html_document
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}

# Libraries and Paths

library(ggplot2)
library(readr)
library(raster)
library(rgdal)
library(tidyr)
library(dplyr)
library(stringr)

dir_M <- c('Windows' = '//mazu.nceas.ucsb.edu/ohi',
           'Darwin'  = '/Volumes/ohi',    ### connect (cmd-K) to smb://mazu/ohi
           'Linux'   = '/home/shares/ohi')[[ Sys.info()[['sysname']] ]]

dir_git <- '~/github/IUCN-AquaMaps'
  
dir_anx <- file.path(dir_M, 'git-annex/globalprep/spp_ico')
dir_fig <- file.path(dir_git, 'figures')
dir_data <- file.path(dir_git, 'data')

source('~/github/IUCN-AquaMaps/data_explore/data_explore_fxns.R')

```


```{r get_spp_cells, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}

### get rgn_cells - local copy
ohi_rgn_cells <- read_csv(file.path(dir_git, 'case_study_ohi/rgn_cells.csv'), 
                          col_types = 'icdd_d')

### get spp_info - git-annex original; modify spp info to exclude BOTW
ohi_spp_info <- read_csv(file.path(dir_anx, 'v2016/int/spp_all_cleaned.csv')) %>%
  filter(!is.na(cat_score))      %>% ### filter out unassessed and DD species
  filter(!is.na(spatial_source)) %>% ### filter out unmapped species
  mutate(spatial_source = ifelse(!is.na(am_sid) & spatial_source == 'iucn-bli', 'am', spatial_source)) %>%
  filter(spatial_source != 'iucn-bli')
  

### Load species cells; filter to species IDs in assessed species list and cell IDs in OHI regions
am_spp_cells <- read_csv(file.path(dir_anx, 'v2016/int/am_cells_spp_prob0.csv')) %>%
  filter(am_sid %in% ohi_spp_info$am_sid) %>% 
  filter(loiczid %in% ohi_rgn_cells$loiczid) %>%
  distinct()

### bind AM loiczid dataframe to species risk category dataframe
am_spp_cells <- am_spp_cells %>%
  left_join(ohi_spp_info %>% select(am_sid, cat_score),
            by = 'am_sid')

### force exclusion of bird IUCN SIDs for IUCN analysis only
iucn_nonbirds <- ohi_spp_info %>%
  select(iucn_sid, spp_group) %>%
  filter(spp_group != 'BOTW')

iucn_spp_cells <- read_csv(file.path(dir_anx, 'v2016/int/iucn_cells_spp.csv'),
                           col_types = 'cddddc') %>%
  filter(presence != 5) %>%
  filter(iucn_sid %in% ohi_spp_info$iucn_sid) %>%
  filter(iucn_sid %in% iucn_nonbirds$iucn_sid) %>% ### exclude BOTW
  filter(loiczid %in% ohi_rgn_cells$loiczid) %>%
  distinct()
### bind IUCN loiczid dataframe to species risk category dataframe
iucn_spp_cells <- iucn_spp_cells %>%
  left_join(ohi_spp_info %>% select(iucn_sid, cat_score),
            by = 'iucn_sid')

```

``` {r calc_ohi_iucn_spp}

### group by loiczid, then summarize to find means (and counts)
iucn_cell_sum <- iucn_spp_cells %>%
  filter(!is.na(cat_score)) %>%
  distinct() %>%
  group_by(loiczid) %>%
  summarize(mean_cat = mean(cat_score),
            n_spp    = n())

write_csv(iucn_cell_sum, file.path(dir_git, 'case_study_ohi/iucn_spp_cell_sum.csv'))

### bind cells to regions dataframe and summarize
iucn_rgn_sum <- iucn_cell_sum %>%
  inner_join(ohi_rgn_cells,
             by = 'loiczid') %>%
  mutate(cell_area_weight = cell_area * n_spp * proportionArea,
         area_weighted_mean_cat = mean_cat * cell_area_weight) %>%
  arrange(loiczid)

iucn_rgn_sum <- iucn_rgn_sum %>%
  group_by(rgn_id, rgn_name) %>%
  summarize(rgn_mean_cat = sum(area_weighted_mean_cat)/sum(cell_area_weight),
            mean_n_spp = mean(n_spp))

iucn_rgn_sum <- iucn_rgn_sum %>%
  mutate(status = 100 * ((1 - rgn_mean_cat) - 0.25) / 0.75)

write_csv(iucn_rgn_sum, file.path(dir_git, 'case_study_ohi/iucn_spp_region_sum.csv'))

```

``` {r calc_ohi_am_spp}

### group by loiczid, then summarize to find means (and counts)
am_cell_sum <- am_spp_cells %>%
  filter(!is.na(cat_score)) %>%
  distinct() %>%
  group_by(loiczid) %>%
  summarize(mean_cat = mean(cat_score),
            n_spp    = n())

write_csv(am_cell_sum, file.path(dir_git, 'case_study_ohi/am_spp_cell_sum.csv'))

### bind cells to regions dataframe and summarize
am_rgn_sum <- am_cell_sum %>%
  inner_join(ohi_rgn_cells,
             by = 'loiczid') %>%
  mutate(cell_area_weight = cell_area * n_spp * proportionArea,
         area_weighted_mean_cat = mean_cat   * cell_area_weight) %>%
  arrange(loiczid)

am_rgn_sum <- am_rgn_sum %>%
  group_by(rgn_id, rgn_name) %>%
  summarize(rgn_mean_cat = sum(area_weighted_mean_cat)/sum(cell_area_weight),
            mean_n_spp = mean(n_spp))

am_rgn_sum <- am_rgn_sum %>%
  mutate(status = 100 * ((1 - rgn_mean_cat) - 0.25) / 0.75)

write_csv(am_rgn_sum, file.path(dir_git, 'case_study_ohi/am_spp_region_sum.csv'))

```

``` {r calc_ohi_both_spp}

### get AM spp cells for combined scores
spp_ohi_am <- ohi_spp_info %>% 
  filter(str_detect(spatial_source, 'am'))

am_cell_sum_both <- am_spp_cells %>%
  filter(am_sid %in% spp_ohi_am$am_sid) %>%
  filter(!is.na(cat_score)) %>%
  distinct() %>%
  group_by(loiczid) %>%
  summarize(mean_cat = mean(cat_score),
            n_spp    = n(),
            data     = 'am')

### get IUCN spp cells for combined scores
spp_ohi_iucn <- ohi_spp_info %>% 
  filter(str_detect(spatial_source, 'iucn'))

iucn_cell_sum_both <- iucn_spp_cells %>%
  filter(iucn_sid %in% spp_ohi_iucn$iucn_sid) %>%
  filter(!is.na(cat_score)) %>%
  distinct() %>%
  group_by(loiczid) %>%
  summarize(mean_cat = mean(cat_score),
            n_spp    = n(),
            data     = 'iucn')

### Stick IUCN and AM together and find spp-weighted mean category
ohi_cell_sum <- iucn_cell_sum_both %>%
  bind_rows(am_cell_sum_both) %>%
  mutate(mean_weight_cat = mean_cat * n_spp) %>%
  group_by(loiczid) %>%
  summarize(mean_cat = sum(mean_weight_cat, na.rm = TRUE) / sum(n_spp, na.rm = TRUE),
            n_spp = sum(n_spp, na.rm = TRUE))

write_csv(ohi_cell_sum, file.path(dir_git, 'case_study_ohi/ohi_cell_sum.csv'))

### bind cells to regions dataframe and summarize by region
ohi_rgn_sum <- ohi_cell_sum %>%
  inner_join(ohi_rgn_cells,
             by = 'loiczid') %>%
  # mutate(rgn_area = cell_area * proportionArea,
  #        area_weighted_mean_cat   = weighted_mean_cat   * rgn_area,
  #        area_weighted_mean_trend = weighted_mean_trend * rgn_area) %>%
  mutate(cell_area_weight = cell_area * n_spp * proportionArea,
         area_weighted_mean_cat = mean_cat   * cell_area_weight) %>%
  arrange(loiczid)

ohi_rgn_sum <- ohi_rgn_sum %>%
  group_by(rgn_id, rgn_name) %>%
  summarize(rgn_mean_cat = sum(area_weighted_mean_cat)/sum(cell_area_weight),
            mean_n_spp = mean(n_spp))

ohi_rgn_sum <- ohi_rgn_sum %>%
  mutate(status = 100 * ((1 - rgn_mean_cat) - 0.25) / 0.75)

write_csv(ohi_rgn_sum, file.path(dir_git, 'case_study_ohi/ohi_spp_region_sum.csv'))

```

``` {r create_violin_plots}
dir_fig <- '~/github/IUCN-AquaMaps/figures'

iucn_rgn_sum  <- read_csv(file.path(dir_git, 'case_study_ohi/iucn_spp_region_sum.csv'))
am_rgn_sum    <- read_csv(file.path(dir_git, 'case_study_ohi/am_spp_region_sum.csv'))
ohi_rgn_sum   <- read_csv(file.path(dir_git, 'case_study_ohi/ohi_spp_region_sum.csv'))

status_df <- ohi_rgn_sum %>%
  select(rgn_id, rgn_name, ohi_st = status, mean_n_spp) %>%
  distinct() %>%
  mutate(ohi_st = ohi_st) %>%
  full_join(am_rgn_sum   %>% 
              select(rgn_id, am_st = status) %>%
              distinct(), 
            by = 'rgn_id') %>%
  full_join(iucn_rgn_sum %>% 
              select(rgn_id, iucn_st = status) %>%
              distinct(), 
            by = 'rgn_id') %>%
  mutate(diff_am   = am_st - ohi_st ,
         diff_iucn = iucn_st - ohi_st) %>%
  gather(scenario, diff, diff_am:diff_iucn)
  
viol_plot <- ggplot(data = status_df, aes(x = scenario, y = diff)) +
  ggtheme_plot + 
  theme(panel.grid.major = element_line(colour = 'grey90', size = .25),
        panel.grid.major.x = element_blank()) +

  geom_hline(yintercept = 0, color = 'gray50', size = .5) +
  geom_violin(fill = 'grey80', alpha = .5,
              scale = 'width',
              draw_quantiles = c(.25, .5, .75)) +
  geom_point(position = position_jitter(w = .3), 
             color = 'black', alpha = 1, size = 0.25) +
  geom_violin(fill = NA, 
              draw_quantiles = c(.25, .5, .75),
              scale = 'width') +
  labs(x = 'Scenario, compared to OHI 2016',
       y = 'Change in SPP status') +
  scale_x_discrete(labels = c('1. AquaMaps only', 
                              '2. IUCN only'))

print(viol_plot)

ggsave(file.path(dir_fig, 'fig4a_violinplot_ohi_maps.png'),
       height = 4.5, width = 8.7, units = 'cm', dpi = 600)
# ggsave(file.path(dir_fig, 'fig4a_violinplot_ohi_maps.png'), device = 'tiff',
#        height = 4.5, width = 8.7, units = 'cm', dpi = 600)

```


``` {r check_weirdness}
### noting that the mean and median by AM only and by IUCN only are both less than OHI...

status_df$am_st %>% mean()     ### 91.352
status_df$am_st %>% median()   ### 92.164
status_df$iucn_st %>% mean()   ### 90.943
status_df$iucn_st %>% median() ### 92.565
status_df$ohi_st %>% mean()    ### 93.628
status_df$ohi_st %>% median()  ### 93.803

am_cell_sum_all <- read_csv(file.path(dir_git, 'case_study_ohi/am_spp_cell_sum.csv'))
iucn_cell_sum_all <- read_csv(file.path(dir_git, 'case_study_ohi/iucn_spp_cell_sum.csv'))
ohi_cell_sum_test <- iucn_cell_sum_both %>%
  rename(mean_cat_i = mean_cat, n_spp_i = n_spp) %>%
  select(-data) %>%
  full_join(am_cell_sum_both %>%
              rename(mean_cat_a = mean_cat, n_spp_a = n_spp) %>%
              select(-data), 
            by = 'loiczid')


spp_info_trunc <- ohi_spp_info %>%
  select(am_sid, iucn_sid, sciname, cat_score, spp_group, spatial_source)

spp_ohi_am <- spp_info_trunc %>% 
  filter(str_detect(spatial_source, 'am'))
spp_ohi_iucn <- spp_info_trunc %>% 
  filter(str_detect(spatial_source, 'iucn'))

### examine one cell with lots of species to see what's happening
a_all <- am_spp_cells %>%
  filter(loiczid == 161563) %>%
  inner_join(spp_info_trunc) %>%
  distinct()
a_ohi <- am_spp_cells %>%
  filter(loiczid == 161563) %>%
  inner_join(spp_ohi_am) %>%
  mutate(type = 'ohi') %>%
  distinct()
a <- a_all %>%
  full_join(a_ohi)
i_all <- iucn_spp_cells %>%
  filter(loiczid == 161563) %>%
  inner_join(spp_info_trunc) %>%
  distinct()
i_ohi <- iucn_spp_cells %>%
  filter(loiczid == 161563) %>%
  inner_join(spp_ohi_iucn) %>%
  mutate(type = 'ohi') %>%
  distinct()
i <- i_all %>%
  full_join(i_ohi)

# > mean(a$cat_score)
# [1] 0.04671916
# > mean(a$cat_score[is.na(a$type)])
# [1] 0.2727273
### for OHI, 44 (out of 381) relatively unhealthy species are removed from AM presence for this cell,
### because the presence is driven by IUCN maps.
### If they aren't replaced by IUCN presence, then this cell's score will seem artificially
### healthier.

### OK check a region with large IUCN changes and small spp numbers:
### rgn 4 Macquarie Island

macq_cells <- ohi_rgn_cells %>% filter(rgn_id == 4)
### examine one rgn with lots of species to see what's happening
a_rgn_all <- am_spp_cells %>%
  filter(loiczid %in% macq_cells$loiczid) %>%
  inner_join(spp_info_trunc) %>%
  distinct() %>%
  group_by(am_sid, cat_score, sciname) %>%
  summarize(n_cells_spp = n())
a_rgn_ohi <- am_spp_cells %>%
  filter(loiczid %in% macq_cells$loiczid) %>%
  inner_join(spp_ohi_am) %>%
  distinct() %>%
  group_by(am_sid, cat_score, sciname) %>%
  summarize(n_cells_spp = n()) %>%
  mutate(type = 'ohi')
a_rgn <- a_rgn_all %>%
  full_join(a_rgn_ohi)
i_rgn_all <- iucn_spp_cells %>%
  filter(loiczid %in% macq_cells$loiczid) %>%
  inner_join(spp_info_trunc) %>%
  distinct() %>%
  group_by(iucn_sid, cat_score, sciname) %>%
  summarize(n_cells_spp = n())
i_rgn_ohi <- iucn_spp_cells %>%
  filter(loiczid %in% macq_cells$loiczid) %>%
  inner_join(spp_ohi_iucn) %>%
  distinct() %>%
  group_by(iucn_sid, cat_score, sciname) %>%
  summarize(n_cells_spp = n()) %>%
  mutate(type = 'ohi')
i_rgn <- i_rgn_all %>%
  full_join(i_rgn_ohi)

a_rgn_overlap <- a_rgn %>% filter(is.na(type)) %>%
  ungroup() %>%
  mutate(weighted_cat = cat_score * n_cells_spp,
         weighted_cat_mean = sum(weighted_cat) / sum(n_cells_spp))
a_rgn_overlap$cat_score %>% mean()
a_rgn_overlap$n_cells_spp %>% mean()
a_rgn_overlap$weighted_cat_mean[1]
### Removed these species and replaced with IUCN:
### 0.1155556 mean cat score; 149.1556 mean cells; 45 species; mean weighted cat .2553

i_rgn_replace <- i_rgn %>% filter(sciname %in% a_rgn_overlap$sciname) %>%
  ungroup() %>%
  mutate(weighted_cat = cat_score * n_cells_spp,
         weighted_cat_mean = sum(weighted_cat) / sum(n_cells_spp))
i_rgn_replace$cat_score %>% mean()
i_rgn_replace$n_cells_spp %>% mean()
i_rgn_replace$weighted_cat_mean[1]
### These species overwrote AM species for combined score:
### 0.225 mean cat score; 260.2 mean cells; 16 spp; .191 mean weighted cat

look at weighted means globally