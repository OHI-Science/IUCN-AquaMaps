---
title: 'Data Exploration: IUCN and AquaMaps'
output: html_document
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}

# Libraries and Paths

# library(rasterVis)
library(ggplot2)
library(maps)
library(readr)
library(raster)
library(data.table)
library(tidyr)
library(dplyr)
library(stringr)

dir_N <- c('Windows' = '//neptune.nceas.ucsb.edu/data_edit',
           'Darwin'  = '/Volumes/data_edit',
           'Linux'   = '/var/data/ohi')[[ Sys.info()[['sysname']] ]]

dir_anx <- file.path(dir_N, 'git-annex/globalprep/SPP_ICO')
dir_data <- file.path(dir_N, 'git-annex/globalprep/_raw_data')
dir_fig <- file.path(getwd(), 'figures')

source('R/data_explore_fxns.R')
```

```{r read_am_and_iucn_data, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}

# Data files
#iucn spp cells WITHOUT extinct locations of IUCN subpopulations
iucn_spp_cells <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/iucn_spp_cells_2015.csv'), 
                           col_types = 'cdddd', progress = TRUE) %>%
  as.data.frame() %>%
  filter(presence != 5) ### removes extinct subpopulations

am_spp_cells   <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/am_spp_cells_2015.csv'), progress = TRUE)


### LOICZID cell ID numbers - used in plotting rasters
loiczid_raster_file  <- 'shiny/data/loiczid_raster.grd'
loiczid_raster       <- raster(loiczid_raster_file)
names(loiczid_raster) <- 'loiczid'
```


```{r get_spp_list, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}
data_file <- 'data/spp_list_w_area_percent_noextinct_2015.csv'


if (!file.exists(data_file)) {
  ### species info list - scinames, IUCN species ID, AM species ID, category etc
  spp_list_base <- read.csv('data/spp_am_v_iucn_2015_inclDD.csv', stringsAsFactors = FALSE)
  
  create_spp_list(spp_list_base, data_file)
}

spp_list1 <- read.csv(data_file, stringsAsFactors = FALSE)
```

Note: At this point the species list (`spp_list1`) still contains data deficient species.  274 species show zero area for IUCN; most of these are DD.  The next chunk filters for `!is.na(sm_perc)` and `popn_category != 'DD'`

``` {r eliminate DD and NA areas, echo = FALSE, warning = FALSE}
spp_list <- spp_list1 %>% 
  filter(!is.na(sm_perc))

DT::datatable(spp_list %>%
                 select(sciname, am_sid, iucn_sid, am_review = reviewed, 
                        cat = popn_category, trend = popn_trend, spp_group, 
                        A_tot = total_area, A_am = am_area, A_iucn = iucn_area, 
                        sm_perc, sm_range, area_ratio, lg_area_pct))

```


``` {r child = 'R/data_explore_pt1.Rmd', eval = FALSE}
```
# bar chart: number of spp per group
# scatter plot: area compare IUCN vs AM, including log plot and plot by species group
# rangemap: Chromis alpha 

``` {r, child = 'R/data_explore_pt2.Rmd', eval = FALSE}
```

###(4) Looking at the percent of smaller species range that is within the larger range. 

For each range 

```{r pct_small_within_large, echo = FALSE, warning = FALSE, eval = TRUE}

spp_df4 <- spp_list %>%
  dplyr::select(sciname, sm_perc, sm_range) %>%
  unique()

hist_sm_within_lg <- ggplot(spp_df4, aes(sm_perc, fill = sm_range)) + 
  ggtheme_plot + 
  geom_histogram(aes(y = ..count../sum(..count..)), binwidth = 4, alpha = .8) +
  scale_fill_discrete(name = 'Dataset with smaller range', labels = c('AquaMaps', 'IUCN')) + 
  labs(title = 'Percent of smaller range within larger range 2015 data',
       x = 'Percent of smaller range that falls within the larger range', 
       y = sprintf('Proportion of all species (n = %s)', nrow(spp_df4)))

ggsave(file.path(dir_fig, 'PercSmallRangeInLarger.png'), width = 6, height = 4)

print(hist_sm_within_lg)

```


``` {r pct_overlap_vs_ratio_of_area, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}


### define 25% and 75% quartiles for both x and y axes
area_ratio_quartiles <- quantile(spp_list$area_ratio, na.rm = TRUE)[2:4]
pct_overlap_quartiles <- quantile(spp_list$sm_perc, na.rm = TRUE)[2:4]

### define representative species from each quadrant, for over-plotting
spp_quads <- c('q1' = 'Kajikia albida', 
               'q2' = 'Galaxea cryptoramosa', 
               'q4' = 'Acanthurus nigroris', 
               'q4a' = 'Metanephrops australiensis', 
               'q3' = 'Conus magnificus')

### truncate the species names for the representative species
spp_list_label <- spp_list %>%
  filter(sciname %in% spp_quads) %>%
  separate(sciname, c('g', 's'), sep = ' ', remove = FALSE) %>%
  mutate(sciname_label = paste(str_sub(g, 1, 1), '. ', s, sep = '')) %>%
  select(-g, -s)

### mongo plot time
scatter_arearatio_vs_overlap <- ggplot(spp_list %>% 
                                         transform(popn_category = reorder(popn_category, category_score)),
                                       aes(x = area_ratio, y = sm_perc, 
                                           color = popn_category,
                                           size = popn_category
                                           )) + 
  ggtheme_plot + 
  ### color the quadrant backgrounds:
    annotate("rect", xmin = area_ratio_quartiles[2],  xmax = 100, 
                     ymin = pct_overlap_quartiles[2], ymax = 100, alpha = .3, fill= "green4")  + 
    annotate("rect", xmin = area_ratio_quartiles[2],  xmax =   0, 
                     ymin = pct_overlap_quartiles[2], ymax = 100, alpha = .3, fill= "greenyellow") + 
    annotate("rect", xmin = area_ratio_quartiles[2],  xmax = 100, 
                     ymin = pct_overlap_quartiles[2], ymax =   0, alpha = .3, fill= "orange") + 
    annotate("rect", xmin = area_ratio_quartiles[2],  xmax =   0, 
                     ymin = pct_overlap_quartiles[2], ymax =   0, alpha = .3, fill= "orangered2") + 
  geom_point() + 
  scale_colour_manual(values = c('LC' = 'green4', 
                                 'NT' = 'greenyellow', 
                                 'VU' = 'yellow', 
                                 'EN' = 'orange', 
                                 'CR' = 'orangered2',
                                 'DD' = 'grey50')) +
  geom_vline(x = area_ratio_quartiles[c(1, 3)],
             color = 'grey50', linetype = 'dashed') +
  geom_hline(y = pct_overlap_quartiles[c(1, 3)],
             color = 'grey50', linetype = 'dashed') +
  geom_point(data = spp_list_label, shape = 4, color = 'grey30', size = 4) + 
  geom_text(data = spp_list_label, 
            aes(label = sciname_label), 
            color = 'grey30',
            fontface = 'bold.italic',
            size = 2,
            hjust = .25,
            vjust = 1.5) +
  labs(x = 'Area match: \n(range area smaller : range area larger) * 100%', 
       y = 'Distribution match: \n % overlap of smaller range w/ larger', 
       title = 'Area match vs distribution match',
       color = 'Risk', size = 'Risk')

ggsave(file.path(dir_fig, 'AreaRatiovsPercOverlap.png'), width = 6, height = 4)

print(scatter_arearatio_vs_overlap)

```

```{r plot_spp_from_quadrants, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}

for (i in 1:length(spp_quads)) { # i = 1
  spp <- spp_quads[i]
  spp_quad <- names(spp_quads)[i]
  
  spp_plot <- plot_rangemap(spp)
  print(spp_plot)
  
  ggsave(filename = file.path(dir_fig, sprintf('rangemap_%s_%s.png', spp_quad,
                                               str_replace(tolower(spp), ' ', '_'))),
         plot = spp_plot, 
         width = 8, height = 4, dpi = 200)
}

```


``` {r examine_spp_gp_quartiles, echo = FALSE, eval = TRUE}

spp_list1 <- spp_list %>%
  group_by(spp_group) %>%
  mutate(n_spp = n()) %>%
  ungroup()

### Create species lists by quadrant
spp_list_q1 <- spp_list1 %>%
  filter(area_ratio >= median(area_ratio, na.rm = TRUE) & sm_perc >= median(sm_perc, na.rm = TRUE))
spp_list_q2 <- spp_list1 %>%
  filter(area_ratio < median(area_ratio, na.rm = TRUE) & sm_perc >= median(sm_perc, na.rm = TRUE))
spp_list_q3 <- spp_list1 %>%
  filter(area_ratio >= median(area_ratio, na.rm = TRUE) & sm_perc < median(sm_perc, na.rm = TRUE))
spp_list_q4 <- spp_list1 %>%
  filter(area_ratio < median(area_ratio, na.rm = TRUE) & sm_perc < median(sm_perc, na.rm = TRUE))

### Summarize quadrant species list by species group (e.g. CORALS1)
spp_gp_q1 <- spp_list_q1 %>%
  group_by(spp_group) %>%
  summarize(n_spp = first(n_spp), n_spp_q1 = n())
spp_gp_q2 <- spp_list_q2 %>%
  group_by(spp_group) %>%
  summarize(n_spp = first(n_spp), n_spp_q2 = n())
spp_gp_q3 <- spp_list_q3 %>%
  group_by(spp_group) %>%
  summarize(n_spp = first(n_spp), n_spp_q3 = n())
spp_gp_q4 <- spp_list_q4 %>%
  group_by(spp_group) %>%
  summarize(n_spp = first(n_spp), n_spp_q4 = n())

### Join species group by quadrant into a single dataframe
spp_gp_quadrants <- spp_gp_q1 %>%
  left_join(spp_gp_q2, by = c('spp_group', 'n_spp')) %>%
  left_join(spp_gp_q3, by = c('spp_group', 'n_spp')) %>%
  left_join(spp_gp_q4, by = c('spp_group', 'n_spp')) %>%
  gather(quad, n_quad, n_spp_q1, n_spp_q2, n_spp_q3, n_spp_q4) %>% 
  mutate(quad = str_replace(quad, 'n_spp_', ''),
         pct_quad = n_quad/n_spp)


spp_gp_quadrants <- spp_gp_quadrants %>%
  left_join(spp_gp_quadrants %>% 
              filter(quad == 'q1') %>%
              select(spp_group, pct_q1 = pct_quad),
            by = 'spp_group') %>%
  mutate(quad = str_replace(quad, 'q1', 'q1 well-matched'),
         quad = str_replace(quad, 'q2', 'q2 dist-matched'),
         quad = str_replace(quad, 'q3', 'q3 area-matched'),
         quad = str_replace(quad, 'q4', 'q4 poorly matched'))

### Plot the bar chart
barchart_spp_gp_quads <- ggplot(spp_gp_quadrants %>% 
                                  transform(spp_group = reorder(spp_group, pct_q1)), 
                                aes(x = spp_group, fill = quad, weight = pct_quad)) +
  ggtheme_plot + 
  geom_bar(stat = 'bin', alpha = .5) +
  scale_fill_manual(values = c('q1 well-matched'   = 'green4', 
                               'q2 dist-matched'   = 'greenyellow', 
                               'q3 area-matched'   = 'orange', 
                               'q4 poorly matched' = 'orangered2')) +
  geom_text(aes(label = sprintf('n = %s', n_spp), y = .05), hjust = 0, size = 4) +
  coord_flip() +
  labs(x = 'Species Group', 
       y = 'Relative number of species per quadrant', 
       title = 'Species group breakdown by quadrant 2015 data')

print(barchart_spp_gp_quads)
ggsave(plot = barchart_spp_gp_quads,
       filename = file.path(dir_fig, 'barchart_spp_gp_quads.png'),
       width = 6, height = 4)

```

Plotting species from q1 (well-matched) (see data_explore_quadmaps.html for plots)
```{r plot_spp_from_q1, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

x <- 20
y <- nrow(spp_list_q1)

spp_names_q1 <- spp_list_q1$sciname[seq(1, y, y/x)]

for (spp in spp_names_q1) { # i = 1
  spp_plot <- plot_rangemap(spp)
  spp_solo <- spp_list %>% filter(sciname == spp)
  text_tag <- sprintf('Overlap: %s%%, area ratio: %s%%', round(spp_solo$sm_perc, 1), round(spp_solo$area_ratio, 1))
  spp_plot <- spp_plot +
    labs(title = sprintf('%s, quadrant 1: %s', spp, text_tag))

  print(spp_plot)
  
  # ggsave(filename = file.path(dir_fig, sprintf('rangemap_q1_%s.png', str_replace(tolower(spp), ' ', '_'))),
  #        plot = spp_plot, 
  #        width = 8, height = 4, dpi = 200)
}

```

Plotting species from q2 (distribution-matched)
```{r plot_spp_from_q2, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

x <- 20
y <- nrow(spp_list_q2)

spp_names_q2 <- spp_list_q2$sciname[seq(1, y, y/x)]

for (spp in spp_names_q2) { # i = 1
  spp_plot <- plot_rangemap(spp)
  spp_solo <- spp_list %>% filter(sciname == spp)
  text_tag <- sprintf('Overlap: %s%%, area ratio: %s%%', round(spp_solo$sm_perc, 1), round(spp_solo$area_ratio, 1))
  spp_plot <- spp_plot +
    labs(title = sprintf('%s, quadrant 2: %s', spp, text_tag))
  print(spp_plot)
  
  # ggsave(filename = file.path(dir_fig, sprintf('rangemap_q2_%s.png', str_replace(tolower(spp), ' ', '_'))),
  #        plot = spp_plot, 
  #        width = 8, height = 4, dpi = 200)
}


```


Plotting species from q3 (area-matched)
```{r plot_spp_from_q3, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

x <- 20
y <- nrow(spp_list_q3)

spp_names_q3 <- spp_list_q3$sciname[seq(1, y, y/x)]

for (spp in spp_names_q3) { # i = 1
  spp_plot <- plot_rangemap(spp)
  spp_solo <- spp_list %>% filter(sciname == spp)
  text_tag <- sprintf('Overlap: %s%%, area ratio: %s%%', round(spp_solo$sm_perc, 1), round(spp_solo$area_ratio, 1))
  spp_plot <- spp_plot +
    labs(title = sprintf('%s, quadrant 3: %s', spp, text_tag))
  print(spp_plot)
  
  # ggsave(filename = file.path(dir_fig, sprintf('rangemap_q3_%s.png', str_replace(tolower(spp), ' ', '_'))),
  #        plot = spp_plot, 
  #        width = 8, height = 4, dpi = 200)
}


```

Plotting species from q4 (poorly matched)
```{r plot_spp_from_q4, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

x <- 20
y <- nrow(spp_list_q4)

spp_names_q4 <- spp_list_q4$sciname[seq(1, y, y/x)]

for (spp in spp_names_q4) { # i = 1
  spp_plot <- plot_rangemap(spp)
  spp_solo <- spp_list %>% filter(sciname == spp)
  text_tag <- sprintf('Overlap: %s%%, area ratio: %s%%', round(spp_solo$sm_perc, 1), round(spp_solo$area_ratio, 1))
  spp_plot <- spp_plot +
    labs(title = sprintf('%s, quadrant 4: %s', spp, text_tag))
  print(spp_plot)
  
  # ggsave(filename = file.path(dir_fig, sprintf('rangemap_q4_%s.png', str_replace(tolower(spp), ' ', '_'))),
  #        plot = spp_plot, 
  #        width = 8, height = 4, dpi = 200)
}


```

*** 

###Global representation of species

By counting the number of unique species are found in each of the half degree cells we can then create a single global raster of number of species.

```{r global_dist_map, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

### find total species in each dataset for later percent calcs
am_n_tot   <- am_spp_cells %>% 
  filter(am_sid %in% unique(spp_list$am_sid)) %>%
  select(am_sid) %>% 
  unique() %>% nrow()
iucn_n_tot <- iucn_spp_cells %>% 
  filter(sciname %in% unique(spp_list$sciname)) %>%
  select(sciname) %>% 
  unique() %>% nrow()
### good - the same number

### Number of aquamaps species per cell
am_n_per_cell <- am_spp_cells %>%
  filter(am_sid %in% unique(spp_list$am_sid)) %>%
  group_by(loiczid) %>%
  summarize(count_am = n(),
            pct_am = count_am/am_n_tot) %>%
  as.data.frame()

am_sp_map <- subs(loiczid_raster, am_n_per_cell[ , c('loiczid', 'count_am')], 
                  by = 'loiczid', 
                  which = 'count_am', 
                  subsWithNA = TRUE)

### Number of IUCN species per cell
iucn_n_per_cell <- iucn_spp_cells %>%
  group_by(loiczid) %>%
  summarize(count_iucn = n(),
            pct_iucn = count_iucn/iucn_n_tot) %>%
  as.data.frame()

iucn_sp_map <- subs(loiczid_raster, iucn_n_per_cell[ , c('loiczid', 'count_iucn')], 
                    by = 'loiczid', 
                    which = 'count_iucn', 
                    subsWithNA = TRUE)

### Plot both maps
myTheme <- rasterTheme(region = brewer.pal('Blues', n = 9))

am_lvlplot <- levelplot(am_sp_map, par.settings = myTheme, 
          main = 'Aquamaps Dataset 2015', 
          colorkey = list( at = seq(0, 1063, length = 15)))

png(file.path(dir_fig, 'levelplot_am.png'))
print(am_lvlplot)
dev.off()

iucn_lvlplot <- levelplot(iucn_sp_map, par.settings = myTheme, 
          main = 'IUCN Dataset', 
          colorkey = list(at = seq(0, 1063, length = 15)))

png(file.path(dir_fig, 'levelplot_iucn.png'))
print(iucn_lvlplot)
dev.off()


```

Now look at all aquamaps species

```{r all_aquamaps, eval = FALSE, echo = FALSE}

am_spp_cells_big <- fread(file.path(dir_data, 'aquamaps/v2015/csv/hcaf_sp_native_trunc.csv')) %>%
  as.data.frame()

### find total spp to allow for percent calcs later
am_all_n_tot <- am_spp_cells_big %>% 
  select(speciesid) %>% 
  unique() %>% 
  nrow()

all_am <- am_spp_cells_big %>%
  select(speciesid, loiczid) %>%
  group_by(loiczid) %>%
  summarize(all_count = n(),
            all_pct   = all_count/am_all_n_tot) %>%
  as.data.frame()


all_am_map <- subs(loiczid_raster, all_am[ , c('loiczid', 'all_count')], 
                   by = 'loiczid', 
                   which = 'all_count', 
                   subsWithNA = TRUE)

am_lvlplot_all <- levelplot(all_am_map, par.settings = myTheme, 
                            main = 'Entire Aquamaps Dataset 2015')

png(file.path(dir_fig, 'levelplot_am_all.png'))
print(am_lvlplot_all)
dev.off()

```

![image](figs2015/all_aquamaps_map.png)

``` {r variations_on_gl_dist_maps, echo = FALSE, eval = FALSE}
### find distribution by percent of total species
am_sp_pct_map <- subs(loiczid_raster, am_n_per_cell[ , c('loiczid', 'pct_am')], 
                      by = 'loiczid', 
                      which = 'pct_am', 
                      subsWithNA = TRUE)
iucn_sp_pct_map <- subs(loiczid_raster, iucn_n_per_cell[ , c('loiczid', 'pct_iucn')], 
                        by = 'loiczid', 
                        which = 'pct_iucn', 
                        subsWithNA = TRUE)
### find difference in percent between the two distribution maps; should be small,
### if species are well-matched, since it's all the same species
diff_pct_map    <- iucn_sp_pct_map - am_sp_pct_map

### plot maps with distributions as percentages.  Should it be 0 - 1, or 
### 0 - max value?
levelplot(am_sp_pct_map, par.settings = myTheme, 
          main = 'Aquamaps Dataset pct', 
          colorkey = list( at = seq(0, 1, length = 15)))
levelplot(iucn_sp_pct_map, par.settings = myTheme, 
          main = 'IUCN Dataset pct', 
          colorkey = list(at = seq(0, 1, length = 15)))
### this is the difference one. Should it be min value to max value?
levelplot(diff_pct_map, par.settings = myTheme, 
          main = 'IUCN pct - AM pct', 
          colorkey = list(at = seq(-1, 1, length = 15)))

### Do similar, but with the full aquamaps list (should also do this
### against the full IUCN list...)
all_am_pct_map <- subs(loiczid_raster, all[ , c('loiczid', 'all_pct')], 
                   by = 'loiczid', 
                   which = 'all_pct', 
                   subsWithNA = TRUE)

diff_pct_map2    <- iucn_sp_pct_map - all_am_pct_map
levelplot(all_am_pct_map, par.settings = myTheme, main = 'Entire Aquamaps Dataset, pct')
levelplot(diff_pct_map2, par.settings = myTheme, main = 'iucn (overlap only) - aquamaps (all)')

```



``` {r, child = 'R/data_explore_am_thresh.Rmd', eval = FALSE}
```


## Changes in SPP for scenarios

Comparing three scenarios to the current (v2015) global model for SPP:

* Baseline is: preferring IUCN rangemaps over Aquamaps rangemaps; Aquamaps 'presence' threshold is set at 40% or greater.
* Scenario 1: preferring IUCN rangemaps over Aquamaps; AM presence threshold set at >= 1% (effectively, all occurrences).
* Scenario 2: preferring AM maps over IUCN; AM presence >= 40%.
* Scenario 3: preferring AM over IUCN; AM presence >= 1%.

Boxplots:

![Absolute change in SPP score](figs2015/SPP_scenarios/boxplot_abs_diff.png)

![Relative change in SPP score](figs2015/SPP_scenarios/boxplot_rel_diff.png)