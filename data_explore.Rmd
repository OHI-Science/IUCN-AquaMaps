---
title: 'Data Exploration: IUCN and AquaMaps'
output: html_document
---

```{r, echo = FALSE, warning = FALSE, message = FALSE}

# Libraries and Paths

library(rasterVis)
library(ggplot2)
library(maps)
library(readr)
library(raster)
library(data.table)
library(tidyr)
library(dplyr)
library(stringr)

dir_N <- c('Windows' = '//neptune.nceas.ucsb.edu/data_edit',
           'Darwin'  = '/Volumes/data_edit',
           'Linux'   = '/var/data/ohi')[[ Sys.info()[['sysname']] ]]

dir_anx <- file.path(dir_N, 'git-annex/globalprep/SPP_ICO')
dir_fig <- file.path(getwd(), 'figures')

source('R/data_explore_fxns.R')
```

```{r read_am_and_iucn_data, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}

# Data files
#iucn spp cells WITHOUT extinct locations of IUCN subpopulations
iucn_spp_cells <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/iucn_spp_cells_both.csv'), 
                           col_types = 'cdddd', progress = TRUE) %>%
  as.data.frame() %>%
  filter(presence != 5) ### removes extinct subpopulations

am_spp_cells   <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/am_spp_cells.csv'), progress = TRUE)


### LOICZID cell ID numbers - used in plotting rasters
loiczid_raster_file  <- 'shiny/data/loiczid_raster.grd'
loiczid_raster       <- raster(loiczid_raster_file)
names(loiczid_raster) <- 'loiczid'
```


```{r get spp_list, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}
data_file <- 'data/spp_list_w_area_percent_noextinct.csv'


if(!file.exists(data_file)) {
  ### species info list - scinames, IUCN species ID, AM species ID, category etc
  spp_list_base <- read.csv('shiny/data/spp_am_v_iucn.csv', stringsAsFactors = FALSE)
  
  create_spp_list(spp_list_base, data_file)
}

spp_list <- read.csv(data_file, stringsAsFactors = FALSE)
```

``` {r child = 'R/data_explore_pt1.Rmd', eval = FALSE}
```

``` {r, child = 'R/data_explore_pt2.Rmd', eval = FALSE}
```

###(4) Looking at the percent of smaller species range that is within the larger range. 

For each range 

```{r pct small within large, echo = FALSE, warning = FALSE, eval = TRUE}

spp_df4 <- spp_list %>%
  dplyr::select(sciname, sm_perc, sm_range) %>%
  unique()
      

hist_sm_within_lg <- ggplot(spp_df4, aes(sm_perc, fill = sm_range)) + 
  ggtheme_plot + 
  geom_histogram(aes(y = ..count../sum(..count..)), binwidth = 4, alpha = .8) +
  scale_fill_discrete(name = 'Dataset with smaller range', labels = c('AquaMaps', 'IUCN')) + 
  labs(title = 'Percent of smaller range within larger range',
       x = 'Percent of smaller range that falls within the larger range', 
       y = sprintf('Proportion of all species (n = %s)', nrow(spp_df4)))

ggsave(file.path(dir_fig, 'PercSmallRangeInLarger.png'), width = 6, height = 4)

print(hist_sm_within_lg)

```


``` {r pct overlap vs ratio of area, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}

spp_list <- spp_list %>%
  mutate(area_ratio = am_area / iucn_area,
         area_ratio = ifelse(area_ratio > 1, 1 / area_ratio, area_ratio),
         area_ratio = area_ratio * 100)

area_ratio_quartiles <- quantile(spp_list$area_ratio, na.rm = TRUE)[2:4]
pct_overlap_quartiles <- quantile(spp_list$sm_perc, na.rm = TRUE)[2:4]

spp_quads <- c('q1' = 'Kajikia albida', 
               'q2' = 'Galaxea cryptoramosa', 
               'q4' = 'Acanthurus nigroris', 
               'q4a' = 'Metanephrops australiensis', 
               'q3' = 'Conus magnificus')

spp_list_label <- spp_list %>%
  filter(sciname %in% spp_quads) %>%
  separate(sciname, c('g', 's'), sep = ' ', remove = FALSE) %>%
  mutate(sciname_label = paste(str_sub(g, 1, 1), '. ', s, sep = '')) %>%
  select(-g, -s)

scatter_arearatio_vs_overlap <- ggplot(spp_list, aes(x = area_ratio, y = sm_perc, color = popn_category, size = category_score)) + 
  ggtheme_plot + 
  ### color the quadrant backgrounds:
    annotate("rect", xmin = area_ratio_quartiles[2],  xmax = 100, 
                     ymin = pct_overlap_quartiles[2], ymax = 100, alpha = .3, fill= "green4")  + 
    annotate("rect", xmin = area_ratio_quartiles[2],  xmax =   0, 
                     ymin = pct_overlap_quartiles[2], ymax = 100, alpha = .3, fill= "greenyellow") + 
    annotate("rect", xmin = area_ratio_quartiles[2],  xmax = 100, 
                     ymin = pct_overlap_quartiles[2], ymax =   0, alpha = .3, fill= "orange") + 
    annotate("rect", xmin = area_ratio_quartiles[2],  xmax =   0, 
                     ymin = pct_overlap_quartiles[2], ymax =   0, alpha = .3, fill= "orangered2") + 
  geom_point() + 
  scale_colour_manual(values = c('LC'   = 'green4', 
                                 'NT'   = 'greenyellow', 
                                 'VU'   = 'yellow', 
                                 'EN'   = 'orange', 
                                 'CR' = 'orangered2')) +
  geom_vline(x = area_ratio_quartiles[c(1, 3)],
             color = 'grey50', linetype = 'dashed') +
  geom_hline(y = pct_overlap_quartiles[c(1, 3)],
             color = 'grey50', linetype = 'dashed') +
  geom_point(data = spp_list_label, aes(size = category_score), color = 'grey30') + 
  geom_text(data = spp_list_label, 
            aes(label = sciname_label), 
            color = 'grey30',
            fontface = 'bold.italic',
            size = 2,
            hjust = .25,
            vjust = 1.5) +
  labs(x = 'Area match: \n(range area smaller : range area larger) * 100%', 
       y = 'Percent overlap smaller range in larger', 
       title = 'Distribution match: \n % overlap of smaller range w/ larger')

ggsave(file.path(dir_fig, 'AreaRatiovsPercOverlap.png'), width = 6, height = 4)

print(scatter_arearatio_vs_overlap)

```

```{r plot_spp_from_quadrants, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}

for (i in 1:length(spp_quads)) { # i = 1
  spp <- spp_quads[i]
  spp_quad <- names(spp_quads)[i]
  
  spp_plot <- plot_rangemap(spp)
  print(spp_plot)
  
  # ggsave(filename = file.path(dir_fig, sprintf('rangemap_%s_%s.png', spp_quad,
  #                                              str_replace(tolower(spp), ' ', '_'))),
  #        plot = spp_plot, 
  #        width = 8, height = 4, dpi = 200)
}

```


``` {r examine_spp_gp_quartiles, echo = FALSE, eval = TRUE}

spp_list1 <- spp_list %>%
  group_by(spp_group) %>%
  mutate(n_spp = n()) %>%
  ungroup()

spp_list_q1 <- spp_list1 %>%
  filter(area_ratio >= median(area_ratio, na.rm = TRUE) & sm_perc >= median(sm_perc, na.rm = TRUE))
spp_list_q2 <- spp_list1 %>%
  filter(area_ratio < median(area_ratio, na.rm = TRUE) & sm_perc >= median(sm_perc, na.rm = TRUE))
spp_list_q3 <- spp_list1 %>%
  filter(area_ratio >= median(area_ratio, na.rm = TRUE) & sm_perc < median(sm_perc, na.rm = TRUE))
spp_list_q4 <- spp_list1 %>%
  filter(area_ratio < median(area_ratio, na.rm = TRUE) & sm_perc < median(sm_perc, na.rm = TRUE))

spp_gp_q1 <- spp_list_q1 %>%
  group_by(spp_group) %>%
  summarize(n_spp = first(n_spp), n_spp_q1 = n())
spp_gp_q2 <- spp_list_q2 %>%
  group_by(spp_group) %>%
  summarize(n_spp = first(n_spp), n_spp_q2 = n())
spp_gp_q3 <- spp_list_q3 %>%
  group_by(spp_group) %>%
  summarize(n_spp = first(n_spp), n_spp_q3 = n())
spp_gp_q4 <- spp_list_q4 %>%
  group_by(spp_group) %>%
  summarize(n_spp = first(n_spp), n_spp_q4 = n())

spp_gp_quadrants <- spp_gp_q1 %>%
  left_join(spp_gp_q2, by = c('spp_group', 'n_spp')) %>%
  left_join(spp_gp_q3, by = c('spp_group', 'n_spp')) %>%
  left_join(spp_gp_q4, by = c('spp_group', 'n_spp')) %>%
  gather(quad, n_quad, n_spp_q1, n_spp_q2, n_spp_q3, n_spp_q4) %>% 
  mutate(quad = str_replace(quad, 'n_spp_', ''),
         pct_quad = n_quad/n_spp)

spp_gp_quadrants <- spp_gp_quadrants %>%
  left_join(spp_gp_quadrants %>% 
              filter(quad == 'q1') %>%
              select(spp_group, pct_q1 = pct_quad),
            by = 'spp_group') %>%
  mutate(quad = str_replace(quad, 'q1', 'q1 well-matched'),
         quad = str_replace(quad, 'q2', 'q2 dist-matched'),
         quad = str_replace(quad, 'q3', 'q3 area-matched'),
         quad = str_replace(quad, 'q4', 'q4 poorly matched'))

barchart_spp_gp_quads <- ggplot(spp_gp_quadrants %>% 
                                  transform(spp_group = reorder(spp_group, pct_q1)), 
                                aes(x = spp_group, fill = quad, weight = pct_quad)) +
  ggtheme_plot + 
  geom_bar(stat = 'bin', alpha = .5) +
  scale_fill_manual(values = c('q1 well-matched'   = 'green4', 
                               'q2 dist-matched'   = 'greenyellow', 
                               'q3 area-matched'   = 'orange', 
                               'q4 poorly matched' = 'orangered2')) +
  geom_text(aes(label = sprintf('n = %s', n_spp), y = .05), hjust = 0, size = 4) +
  coord_flip() +
  labs(x = 'Species Group', 
       y = 'Relative number of species per quadrant', 
       title = 'Species group breakdown by quadrant')

print(barchart_spp_gp_quads)
ggsave(plot = barchart_spp_gp_quads,
       filename = file.path(dir_fig, 'barchart_spp_gp_quads.png'),
       width = 6, height = 4)

```

Plotting species from q1 (well-matched) (see data_explore_quadmaps.html for plots)
```{r plot_spp_from_q1, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

x <- 20
y <- nrow(spp_list_q1)

spp_names_q1 <- spp_list_q1$sciname[seq(1, y, y/x)]

for (spp in spp_names_q1) { # i = 1
  spp_plot <- plot_rangemap(spp)
  spp_solo <- spp_list %>% filter(sciname == spp)
  text_tag <- sprintf('Overlap: %s%%, area ratio: %s%%', round(spp_solo$sm_perc, 1), round(spp_solo$area_ratio, 1))
  spp_plot <- spp_plot +
    labs(title = sprintf('%s, quadrant 1: %s', spp, text_tag))

  print(spp_plot)
  
  # ggsave(filename = file.path(dir_fig, sprintf('rangemap_q1_%s.png', str_replace(tolower(spp), ' ', '_'))),
  #        plot = spp_plot, 
  #        width = 8, height = 4, dpi = 200)
}

```

Plotting species from q2 (distribution-matched)
```{r plot_spp_from_q2, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

x <- 20
y <- nrow(spp_list_q2)

spp_names_q2 <- spp_list_q2$sciname[seq(1, y, y/x)]

for (spp in spp_names_q2) { # i = 1
  spp_plot <- plot_rangemap(spp)
  spp_solo <- spp_list %>% filter(sciname == spp)
  text_tag <- sprintf('Overlap: %s%%, area ratio: %s%%', round(spp_solo$sm_perc, 1), round(spp_solo$area_ratio, 1))
  spp_plot <- spp_plot +
    labs(title = sprintf('%s, quadrant 2: %s', spp, text_tag))
  print(spp_plot)
  
  # ggsave(filename = file.path(dir_fig, sprintf('rangemap_q2_%s.png', str_replace(tolower(spp), ' ', '_'))),
  #        plot = spp_plot, 
  #        width = 8, height = 4, dpi = 200)
}


```


Plotting species from q3 (area-matched)
```{r plot_spp_from_q3, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

x <- 20
y <- nrow(spp_list_q3)

spp_names_q3 <- spp_list_q3$sciname[seq(1, y, y/x)]

for (spp in spp_names_q3) { # i = 1
  spp_plot <- plot_rangemap(spp)
  spp_solo <- spp_list %>% filter(sciname == spp)
  text_tag <- sprintf('Overlap: %s%%, area ratio: %s%%', round(spp_solo$sm_perc, 1), round(spp_solo$area_ratio, 1))
  spp_plot <- spp_plot +
    labs(title = sprintf('%s, quadrant 3: %s', spp, text_tag))
  print(spp_plot)
  
  # ggsave(filename = file.path(dir_fig, sprintf('rangemap_q3_%s.png', str_replace(tolower(spp), ' ', '_'))),
  #        plot = spp_plot, 
  #        width = 8, height = 4, dpi = 200)
}


```

Plotting species from q4 (poorly matched)
```{r plot_spp_from_q4, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

x <- 20
y <- nrow(spp_list_q4)

spp_names_q4 <- spp_list_q4$sciname[seq(1, y, y/x)]

for (spp in spp_names_q4) { # i = 1
  spp_plot <- plot_rangemap(spp)
  spp_solo <- spp_list %>% filter(sciname == spp)
  text_tag <- sprintf('Overlap: %s%%, area ratio: %s%%', round(spp_solo$sm_perc, 1), round(spp_solo$area_ratio, 1))
  spp_plot <- spp_plot +
    labs(title = sprintf('%s, quadrant 4: %s', spp, text_tag))
  print(spp_plot)
  
  # ggsave(filename = file.path(dir_fig, sprintf('rangemap_q4_%s.png', str_replace(tolower(spp), ' ', '_'))),
  #        plot = spp_plot, 
  #        width = 8, height = 4, dpi = 200)
}


```

*** 

###Global representation of species

By counting the number of unique species are found in each of the half degree cells we can then create a single global raster of number of species.

```{r map, echo=F, warning=F, message=F}


# Number of aquamaps species per cell

am_n_per_cell = filter(am_spp_cells,am_sid %in% unique(spp_list$am_sid))%>%
                  group_by(loiczid)%>%
                   summarize(count.am=n())%>%
                    as.data.frame()

am_sp_map = subs(loiczid_raster, am_n_per_cell[ , c('loiczid', 'count.am')], 
                     by = 'loiczid', 
                     which = 'count.am', 
                     subsWithNA = TRUE)

#number of IUCN species per cell
iucn_n_per_cell = iucn_spp_cells%>%
                   group_by(loiczid)%>%
                    summarize(count.iucn=n())%>%
                    as.data.frame()


iucn_sp_map = subs(loiczid_raster, iucn_n_per_cell[ , c('loiczid', 'count.iucn')], 
                     by = 'loiczid', 
                     which = 'count.iucn', 
                     subsWithNA = TRUE)

#Plot both maps
myTheme = rasterTheme(region = brewer.pal('Blues', n = 9))

levelplot(am_sp_map, par.settings = myTheme, main = 'Aquamaps Dataset', colorkey = list( at = seq(0, 1063, length = 15)))

levelplot(iucn_sp_map, par.settings = myTheme, main = 'IUCN Dataset', colorkey = list(at = seq(0, 1063, length = 15)))
```

Now look at all aquamaps species

```{r all aquamaps,eval=F, echo=F}

am_spp_cells_big = fread(file.path(dir_anx, 'raw/aquamaps_2014/tables/ohi_hcaf_species_native.csv'))
#am_spp_cell_big is missing loiczid info so bring in hcaf to match

hcaf <- fread(file.path(dir_anx, 'raw/aquamaps_2014/tables/hcaf.csv')) %>% #bring this in just to get loiczid
          as.data.frame() %>%
            select(CsquareCode, LOICZID) %>%
              rename(loiczid = LOICZID)

all_am = am_spp_cells_big %>%
          select(SpeciesID,CsquareCode) %>%
          group_by(CsquareCode) %>%
          summarize(count=n()) %>%
          as.data.frame()


all = left_join(all_am, hcaf)


all_am_map = subs(loiczid_raster, all[ , c('loiczid', 'count')], 
                     by = 'loiczid', 
                     which = 'count', 
                     subsWithNA = TRUE)

levelplot(all_am_map, par.settings = myTheme, main = 'Entire Aquamaps Dataset')
```

![image](./figures/all_aquamaps_map.png)



``` {r, child = 'R/data_explore_am_thresh.Rmd', eval = FALSE}
```


## Changes in SPP for scenarios

Comparing three scenarios to the current (v2015) global model for SPP:

* Baseline is: preferring IUCN rangemaps over Aquamaps rangemaps; Aquamaps 'presence' threshold is set at 40% or greater.
* Scenario 1: preferring IUCN rangemaps over Aquamaps; AM presence threshold set at >= 1% (effectively, all occurrences).
* Scenario 2: preferring AM maps over IUCN; AM presence >= 40%.
* Scenario 3: preferring AM over IUCN; AM presence >= 1%.

Boxplots:

![Absolute change in SPP score](figures/SPP_scenarios/boxplot_abs_diff.png)

![Relative change in SPP score](figures/SPP_scenarios/boxplot_rel_diff.png)