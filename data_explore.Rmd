---
title: "Data Exploration: IUCN and AquaMaps"
output: html_document
---

```{r,echo=F,warning=FALSE,message=F}

# Librarires and Paths

library(ggplot2)
library(maps)
library(readr)
library(raster)
library(tidyr)
library(dplyr)

dir_N <- c('Windows' = '//neptune.nceas.ucsb.edu/data_edit',
           'Darwin'  = '/Volumes/data_edit',
           'Linux'   = '/var/data/ohi')[[ Sys.info()[['sysname']] ]]

dir_anx      <- file.path(dir_N, 'git-annex/globalprep/SPP_ICO')
```

```{r,echo=F,warning=FALSE,message=F,results='hide'}

# Data files

iucn_spp_cells <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/iucn_spp_cells.csv'), col_types = 'idiii', progress = TRUE)

am_spp_cells   <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/am_spp_cells.csv'), progress = TRUE)

#species list
spp_list <- read.csv('shiny/data/spp_am_v_iucn.csv', stringsAsFactors = FALSE)


#data for raster (used to plot species)

loiczid_raster_file  <- 'shiny/data/loiczid_raster.grd'
loiczid_raster       <- raster(loiczid_raster_file)
names(loiczid_raster) <- 'loiczid'
```

```{r,echo=F,warning=FALSE,message=F}

### Species Map Function ###
# This function takes a single species scientific name as input, then grabs all 
# occurrence cells and associated Aquamaps probability and/or IUCN proportional area
# per cell
get_spp_map <- function(species){
  spp_id <- spp_list %>%
    filter(sciname == species & is.na(parent_sid)) %>%
    dplyr::select(am_sid, iucn_sid, sciname) %>%
    unique()
  iucn_spp_map <- iucn_spp_cells %>%
    filter(iucn_sid == spp_id$iucn_sid) %>%
    dplyr::select(-parent_sid, -subpop_sid, loiczid = iucn_loiczid) %>%
    group_by(loiczid, iucn_sid) %>%        
    summarize(iucn_area = max(iucn_area))
  ### The group_by() and summarize() are to collapse cells with overlapped polygons, fixing the duplicate 'by' issue
  am_spp_map   <- am_spp_cells %>%
    filter(am_sid == spp_id$am_sid) %>%
    rename(loiczid = am_loiczid)
  spp_map <- full_join(iucn_spp_map, am_spp_map, by = 'loiczid') %>%
    as.data.frame()
  
  return(spp_map)
}
```
***  



```{r,echo=F,eval=FALSE,warning=FALSE,message=F}

spp_list = spp_list %>%
              mutate(total_area = NA,
                     am_area    = NA,
                     iucn_area  = NA,
                     perc       = NA,
                     am_perc    = NA,
                     iucn_perc  = NA,
                     sm_perc    = NA, #filled with % of smaller range that is within the larger range
                     sm_range   = NA) #what range is smaller

#there's likely a better way to do this than a for loop (lapply or sapply?)
for (i in 1:nrow(spp_list)){
  
  print(i)
  
  spp     <- spp_list[i, ]$sciname #species name
  
  spp_map <- get_spp_map(spp) #get species map
  
  #get just the aquamaps cells
#   am_spp_map = spp_map%>%
#                   filter(!is.na(am_prob))%>%
#                 dplyr::select(loiczid,am_sid,am_prob)%>% #add in am_prob when we want to look at probability
#                   unique()
  
#   if(TRUE %in% duplicated(am_spp_map$loiczid)){
#                   am_spp_map = am_spp_map%>%
#                                 dplyr::select(loiczid,am_sid)%>%
#                                   unique()}
#   
  #rasterize aquamaps map
#   r_am_spp  <-  subs(loiczid_raster, 
#                      am_spp_map[ , c('loiczid', 'am_sid')], 
#                      by = 'loiczid', 
#                      which = 'am_sid', 
#                      subsWithNA = TRUE)
#   
#   spp_list[i,]$am_area = area(r_am_spp,na.rm=T)%>%
#               cellStats(.,stat='sum')
#   
  
  #get the iucn cells
#   iucn_map <- spp_map %>%
#     mutate(iucn_pres = iucn_area > 0)%>%
#       dplyr::select(loiczid,iucn_area,am_sid,am_prob,iucn_pres)%>%
#         unique()
  
  #TODO: incorporate the iucn_area (area of cell that species overlaps with...I think thats what it is)
  
  #this is incorporated because there are some duplications for loiczids with IUCN cells. I'm guessing this is because of the parent/subpopulations?
  
#    if(TRUE %in% duplicated(iucn_map$loiczid))next()
# #   
#  rasterize IUCN map
#   r_iucn_spp <- subs(loiczid_raster, 
#                      iucn_map[ , c('loiczid', 'iucn_pres')], 
#                     by = 'loiczid', 
#                      which = 'iucn_pres', 
#                      subsWithNA = TRUE)
# #   
#   spp_list[i,]$iucn_area = area(r_iucn_spp,na.rm=T)%>%
#                 cellStats(.,stat='sum')
  
  
  # Get total area (IUCN and AM combined)
  allCells <- spp_map%>%
                dplyr::select(loiczid)%>%
                  mutate(value=1)%>%
                  unique()
            
  
  fullRange <- subs(loiczid_raster, 
                     allCells[ , c('loiczid', 'value')], 
                    by = 'loiczid', 
                     which = 'value', 
                     subsWithNA = TRUE)
  
  spp_list[i,]$total_area = area(fullRange,na.rm=T)%>%
                              cellStats(.,stat='sum')
  
  # get percent overlap of map
  
#   #iucn map cells
#   cells_iucn<-iucn_map%>%
#               filter(iucn_pres==TRUE)%>%
#               .$loiczid
#   cells_am <- am_spp_map%>%
#                 filter(!is.na(am_sid))%>%
#                 .$loiczid
#   
#   cells_total = unique(spp_map$loiczid)
#   cells_overlap = intersect(cells_iucn,cells_am)
#   
#    r_iucn_spp <- subs(loiczid_raster, 
#                       iucn_map[ , c('loiczid', 'iucn_pres')], 
#                      by = 'loiczid', 
#                       which = 'iucn_pres', 
#                       subsWithNA = TRUE)
#   
  #percent overlap
#   perc = (length(cells_overlap)/length(cells_total))*100
#   spp_list[i,]$perc = perc
#   
#   am_only = setdiff(cells_am,cells_iucn)
#   iucn_only = setdiff(cells_iucn,cells_am)
#   
#   perc_am = (length(am_only)/length(cells_total))*100
#   perc_iucn = (length(iucn_only)/length(cells_total))*100
#   
#   spp_list[i,]$am_perc = perc_am
#   spp_list[i,]$iucn_perc = perc_iucn
# 
#   spp_list[i,]$sm_range = ifelse(length(cells_am)<length(cells_iucn),'AM','IUCN') #what dataset has the smaller range
#   spp_list[i,]$sm_perc = length(cells_overlap)/min(length(cells_am),length(cells_iucn))*100 #this is the total percent of smaller range encompassed in the larger range
# cat(perc,perc_am,perc_iucn)
# 


  }


# for Conus arenatus, the IUCN map gives 4 duplicate cells, but each of the entries has a different iucn_area...which doesn't make sense

#row 985 for Acanthurus leucopareius - AM is giving duplicate loiczids but with different am_prob...which is so strange. Looked
# at the raw data and it seems to be in the raw data... (JA on 8/31/15)

write.csv(spp_list,file='spp_list_w_area_percent.csv')
```


###(1) Number of species in both datasets split up by group

```{r,echo=F,warning=F,message=F,warning=FALSE,message=F}
# look at number of species per group

spp_list = read.csv('spp_list_w_area_percent.csv')

df = spp_list%>%
      mutate(diff = iucn_area - am_area)

df <- within(df,spp_group <- factor(spp_group,levels=names(sort(table(spp_group),increasing=TRUE))))

g<-ggplot(df,aes(x=spp_group))+
  geom_bar(stat='bin')+
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=1))+ coord_flip()+
  labs(x='Species Group', y='Number of Species',title='Number of species in both AquaMaps and IUCN datasets')

print(g)
```

***  

###(2) Looking at the total difference in area (km2) for each species range map in both datasets

```{r,echo=F,warning=F,message=F,warning=FALSE,message=F}

dot = ggplot(df,aes(iucn_area,am_area,color=category))+ geom_point() + geom_abline()+
      labs(x='Area (km2) from IUCN dataset',y='Area (km2) from AquaMaps dataset',title='Comparing total area of species range maps')
print(dot)
```


There are large differences so to get a better sense, here is the same comparison but with area log transformed.
````{r echo=F,warning=F,message=F,warning=FALSE,message=F}

df = df%>%
      mutate(am_log = log(am_area),
             iucn_log = log(iucn_area))

all_status <- ggplot(df,aes(iucn_log,am_log,color=category)) + 
  geom_point() + geom_abline() +
  labs(x='IUCN Area (log transformed)', y='AquaMaps Area (log transformed)',
        title= 'Comparing area of range maps\n (all area values are km2 log transformed)',fill='IUCN Category')

print(all_status)
```

Data split into species groups and by IUCN category
```{r,echo=F,warning=F,message=F}

groups <- ggplot(df, aes(iucn_log, am_log,color=category)) + geom_point() +facet_wrap(~spp_group) + 
        geom_abline() + labs(x='IUCN Area (log transformed)', y='AquaMaps Area (log transformed)',
                             title='Comparing differences in area across species groups', fill='IUCN Category')
print(groups)
```
***  

###(3) Looking at the overlap between species range maps from IUCN and AquaMaps  

This plot shows the total percent of a species range map that is (1) only covered by IUCN cells, (2) only covered by AquaMaps cells and (3) covered by both IUCN and AquaMaps cells. 

####How this breaks down between AquaMaps and IUCN

Here is an example of a single species, the yellow speckled chromis (*Chromis alpha*)  

```{r,echo=F,warning=FALSE,message=F}

spp = 'Chromis alpha'
map <- get_spp_map(spp)

 am_map <- map%>%
            filter(!is.na(am_prob))
    
    
    r_am_spp  <-  subs(loiczid_raster, 
                       am_map[ , c('loiczid', 'am_prob')], 
                       by = 'loiczid', 
                       which = 'am_prob', 
                       subsWithNA = TRUE)
    
    r_am_spp[!is.na(r_am_spp)]<-1
    
    
    iucn_map <- map %>%
                  mutate(iucn_pres = iucn_area > 0)
    
    r_iucn_spp <- subs(loiczid_raster, 
                       iucn_map[ , c('loiczid', 'iucn_pres')], 
                       by = 'loiczid', 
                       which = 'iucn_pres', 
                       subsWithNA = TRUE)
    

#plot
  plot(r_iucn_spp,col='mediumpurple',useRaster=FALSE,axes=FALSE,box=FALSE,legend=FALSE)
  plot(r_am_spp,col='orange',main="Yellow-speckled Chromis", useRaster=FALSE,add=T,axes=FALSE,box=FALSE,legend=FALSE)
  map('world', col = 'gray95', fill = T, border = 'gray80', add = TRUE)
  legend("topright",legend=c("AquaMaps","IUCN"),fill=c('orange','mediumpurple'))
  
```
  

```{r,echo=F,warning=FALSE,message=F}
  
  df <- gather(spp_list, perc.type, percent, perc, am_perc, iucn_perc) %>%
          dplyr::select(sciname, spp_group, perc.type, percent) %>%
            unique()
  
  perc_c = df %>%
            filter(sciname == spp)
  
  p1 = perc_c %>% dplyr::select(percent)
  paste0(round(p1[1, ], 2), '% of the total area in this map is covered by both IUCN and AquaMaps')
  paste0(round(p1[2, ], 2), '% of the total area in this map is covered just by AquaMaps')
  paste0(round(p1[3, ], 2), '% of the total area in this map is covered just by IUCN')
```
  
  
####Now looking across all species, here is the breakdown of how much overlap there is between the two datasets  
  
This plot shows that the majority of species range maps have only ~30% of their full map covered by both maps, and almost no species have more than 50% of their two ranges (IUCN and AquaMaps) overlapping.  

```{r,echo=F,warning=FALSE,message=F}


#look at density plot

all<-ggplot(df,aes(percent,fill=perc.type))+
    geom_histogram(binwidth=1,alpha=.3)+
    scale_fill_discrete(name="Legend",labels=c("Overlap", "AquaMaps only", "IUCN only"))+
    labs(x='Percent of total range', y='Number of Species')

print(all)
```



Split up by species - not sure if this is useful or not
```{r,echo=F}

sp <- ggplot(df,aes(percent,fill=perc.type))+geom_histogram(binwidth=1,alpha=.3) +
  facet_wrap(~spp_group) +
  scale_fill_discrete(name="Legend",labels=c("Overlap", "AquaMaps only", "IUCN only"))+
  labs(x='Percent of total range', y='Number of Species')

print(sp)


```


Looking at the percent of smaller species range that is within the larger range. 

```{r pct small within large, echo=F}

d <- spp_list %>%
  dplyr::select(sciname, sm_perc, sm_range) %>%
      unique()
      

ggplot(d, aes(sm_perc, fill = sm_range)) + 
  geom_histogram(binwidth = 1, alpha = .7) +
  scale_fill_discrete(name = "Dataset with smaller range", labels = c("AquaMaps", "IUCN")) + 
  labs(x = 'Percent of smaller range that falls within the larger range', y = 'Number of Species')

```

``` {r pct overlap vs area, echo = FALSE}

reg <- ggplot(spp_list, aes(total_area, sm_perc, color = sm_range)) + 
  geom_point() + 
  geom_abline() + 
  labs(x = 'Total Area (km2)', y = 'Percent overlap smaller range in larger', 
       title = 'Size of species range vs. percent overlap of \nsmaller range with larger')

print(reg)

# remove all area greater than 100000000

l <- spp_list %>% filter(total_area < 100000000)


r <- ggplot(l, aes(total_area, sm_perc, color = sm_range)) + 
  geom_point() + 
  labs(x = 'Total Area (km2)', y = 'Percent overlap smaller range in larger', 
       title = 'Size of species range vs. percent overlap of \nsmaller range with larger')

print(r)


# Log transform area

logA_vs_pct <- ggplot(spp_list, aes(log_total_area, sm_perc, color = sm_range)) + 
  geom_point() + 
  labs(x = 'Total Area (km2)', y = 'Percent overlap smaller range in larger', 
       title = 'Size of species range vs. percent overlap of \nsmaller range with larger')

print(logA_vs_pct)
```

``` {r examine regressions, echo = FALSE}

A_mdl      <- lm(total_area ~ sm_perc, spp_list)
#                Estimate Std. Error t value Pr(>|t|)    
#   (Intercept) -16285410    2858388  -5.697  1.4e-08 ***
#   sm_perc        533370      41702  12.790  < 2e-16 ***
#   Multiple R-squared:  0.07732,	Adjusted R-squared:  0.07685 

A_mdl_clip <- lm(total_area ~ sm_perc, l)
#               Estimate Std. Error t value Pr(>|t|)    
#   (Intercept)  2993939     810560   3.694 0.000227 ***
#   sm_perc       153523      11952  12.844  < 2e-16 ***
#   Multiple R-squared:  0.07955,	Adjusted R-squared:  0.07906 
logA_mdl   <- lm(log_total_area ~ sm_perc, spp_list)
#                Estimate Std. Error t value Pr(>|t|)    
#   (Intercept) 14.775325   0.096446   153.2   <2e-16 ***
#   sm_perc      0.016885   0.001407    12.0   <2e-16 ***
#   Multiple R-squared:  0.0687,	Adjusted R-squared:  0.06823 
```



``` {r examine quartiles, echo = FALSE}



summary(spp_list$total_area)
#      Min.   1st Qu.    Median      Mean   3rd Qu.      Max.
#     55760   3032000  10790000  18500000  22670000 372100000

qtiles <- c(quantile(spp_list$total_area, 0.0),
            quantile(spp_list$total_area, .25),
            quantile(spp_list$total_area, .50),
            quantile(spp_list$total_area, .75),
            quantile(spp_list$total_area, 1.0))
qtile_mdl <- list()
for (i in 1:4) {
  area_clip <- spp_list %>%
    filter(total_area >= qtiles[i] & total_area < qtiles[i + 1])
  qtile_mdl[[i]] <- lm(total_area ~ sm_perc, area_clip)
  
  qtile_plot <- ggplot(area_clip, aes(total_area, sm_perc, color = sm_range)) + 
  geom_point() + 
  labs(x = 'Total Area (km2)', y = 'Percent overlap smaller range in larger', 
       title = 'Size of species range vs. percent overlap of \nsmaller range with larger')

print(qtile_plot)
}
# First quartile regression:
#                 Estimate Std. Error t value Pr(>|t|)    
#     (Intercept)  1423917     101053  14.091   <2e-16 ***
#     sm_perc         1188       1555   0.764    0.445    
#     Multiple R-squared:  0.001198,	Adjusted R-squared:  -0.0008529 
#
# second quartile:
#                 Estimate Std. Error t value Pr(>|t|)    
#     (Intercept)  7011028     275943  25.408  < 2e-16 ***
#     sm_perc       -17725       4228  -4.192 3.28e-05 ***
#     Multiple R-squared:  0.03483,	Adjusted R-squared:  0.03285 
#
# third quartile:
#                 Estimate Std. Error t value Pr(>|t|)    
#     (Intercept) 12813279     507856  25.230  < 2e-16 ***
#     sm_perc        64710       8159   7.931  1.5e-14 ***
#     Multiple R-squared:  0.1146,	Adjusted R-squared:  0.1128 
#
# fourth quartile:
#                   Estimate Std. Error t value Pr(>|t|)    
#     (Intercept) -101736351   17259544  -5.894 7.04e-09 ***
#     sm_perc        1911286     215216   8.881  < 2e-16 ***
#     Multiple R-squared:  0.1399,	Adjusted R-squared:  0.1381 

# This avenue of exploration looks like a bust.

```


``` {r, echo = FALSE}
  

# Regression


lm_eqn <- function(df){
    m  <- lm(total_area ~ sm_perc, spp_list)
    eq <- substitute(italic('Total Area') == a + b %.% italic('Percent')*","~~italic(r)^2~"="~r2, 
          list(a  = format(coef(m)[1], digits = 2), 
               b  = format(coef(m)[2], digits = 2), 
               r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq))             
}

p1 <- reg + geom_text(x = 50, y = 80000000, label = lm_eqn(spp_list), parse = TRUE)


```

