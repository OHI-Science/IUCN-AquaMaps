###Global representation of species

By counting the number of unique species are found in each of the half degree cells we can then create a single global raster of number of species.

``` {r setup, message = FALSE, eval = FALSE}
library(rasterVis)
library(ggplot2)
library(maps)
library(raster)
library(data.table)
library(tidyr)
library(dplyr)
library(stringr)
library(readr)

dir_N <- c('Windows' = '//neptune.nceas.ucsb.edu/data_edit',
           'Darwin'  = '/Volumes/data_edit',
           'Linux'   = '/var/data/ohi')[[ Sys.info()[['sysname']] ]]

dir_anx <- file.path(dir_N, 'git-annex/globalprep/SPP_ICO')
dir_am_data <- file.path(dir_N, 'git-annex/globalprep/_raw_data/aquamaps/v2015/csv')
dir_fig <- file.path(getwd(), 'figures')

source('R/data_explore_fxns.R')




data_file <- 'data/spp_list_w_area_percent_noextinct_2015.csv'

spp_list <- read.csv(data_file, stringsAsFactors = FALSE) %>%
  filter(!is.na(sm_perc)) ### will ditch the ones where no IUCN polygon exists

```

``` {r load data sets, echo = FALSE, message = FALSE}
iucn_spp_cells <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/iucn_spp_cells_2015.csv'), 
                           col_types = 'cdddd', progress = TRUE) %>%
  as.data.frame() %>%
  filter(presence != 5) ### removes extinct subpopulations

am_spp_cells   <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/am_spp_cells_2015.csv'), progress = TRUE)


### LOICZID cell ID numbers - used in plotting rasters
loiczid_raster_file  <- 'shiny/data/loiczid_raster.grd'
loiczid_raster       <- raster(loiczid_raster_file)
names(loiczid_raster) <- 'loiczid'
```


```{r global map matched species, echo = FALSE, warning = FALSE, message = FALSE}

### find total species in each dataset for later percent calcs
# am_n_tot   <- am_spp_cells %>% 
#   filter(am_sid %in% unique(spp_list$am_sid)) %>%
#   dplyr::select(am_sid) %>% 
#   unique() %>% nrow()
# iucn_n_tot <- iucn_spp_cells %>% 
#   filter(sciname %in% unique(spp_list$sciname)) %>%
#   dplyr::select(sciname) %>% 
#   unique() %>% nrow()
### good - the same number

### Number of aquamaps species per cell
iucn_pair_rast_file <- 'rasters/iucn_pair_rast.tif'
am_pair_rast_file   <- 'rasters/am_pair_rast.tif'

if(!file.exists(iucn_pair_rast_file) | !file.exists(am_pair_rast_file)) {
  am_n_per_cell <- am_spp_cells %>%
  filter(am_sid %in% unique(spp_list$am_sid)) %>%
  group_by(loiczid) %>%
  summarize(count_am = n()) %>%
#   summarize(count_am = n(),
#             pct_am = count_am/am_n_tot) %>%
  as.data.frame()

  am_sp_map <- subs(loiczid_raster, am_n_per_cell[ , c('loiczid', 'count_am')], 
                    by = 'loiczid', 
                    which = 'count_am', 
                    subsWithNA = TRUE)
  
  ### Number of IUCN species per cell
  iucn_n_per_cell <- iucn_spp_cells %>%
    group_by(loiczid) %>%
    summarize(count_iucn = n()) %>%
  #   summarize(count_iucn = n(),
  #             pct_iucn = count_iucn/iucn_n_tot) %>%
    as.data.frame()
  
  iucn_sp_map <- subs(loiczid_raster, iucn_n_per_cell[ , c('loiczid', 'count_iucn')], 
                      by = 'loiczid', 
                      which = 'count_iucn', 
                      subsWithNA = TRUE)
  
  writeRaster(iucn_sp_map, filename = iucn_pair_rast_file, overwrite = TRUE)
  writeRaster(am_sp_map, filename = am_pair_rast_file, overwrite = TRUE)
} else {
  am_sp_map   <- raster(am_pair_rast_file)
  iucn_sp_map <- raster(iucn_pair_rast_file)
}

am_ln_map <- log(am_sp_map + 1)
iucn_ln_map <- log(iucn_sp_map + 1)

### Plot both maps
myTheme <- rasterTheme(region = brewer.pal('Blues', n = 9))

levelplot(am_sp_map, par.settings = myTheme, 
          main = 'Aquamaps Dataset', 
          colorkey = list( at = seq(0, 1063, length = 15)))

levelplot(iucn_sp_map, par.settings = myTheme, 
          main = 'IUCN Dataset', 
          colorkey = list(at = seq(0, 1063, length = 15)))

levelplot(am_ln_map, par.settings = myTheme, 
          main = 'Aquamaps Dataset', 
          colorkey = list( at = seq(0, maxValue(am_ln_map), length = 15)))

levelplot(iucn_ln_map, par.settings = myTheme, 
          main = 'IUCN Dataset', 
          colorkey = list(at = seq(0, maxValue(iucn_ln_map), length = 15)))

```

Now look at full aquamaps species

```{r all_aquamaps, eval = FALSE, echo = FALSE}

all_am_rast_file   <- 'rasters/am_all_rast.tif'

if(!file.exists(all_am_rast_file)) {
  am_spp_cells_big <- fread(file.path(dir_am_data, 'hcaf_sp_native_trunc.csv')) %>%
    as.data.frame(stringsAsFactors = FALSE)
  
  ### find total spp to allow for percent calcs later
  # am_all_n_tot <- am_spp_cells_big %>% 
  #   dplyr::select(SpeciesID) %>% 
  #   unique() %>% nrow()
  
  all_am <- am_spp_cells_big %>%
    group_by(loiczid) %>%
    summarize(all_count = n()) %>%
  #   summarize(all_count = n(),
  #             all_pct   = all_count/am_all_n_tot) %>%
    as.data.frame()
  
  all_am_map <- subs(loiczid_raster, all_am[ , c('loiczid', 'all_count')], 
                     by = 'loiczid', 
                     which = 'all_count', 
                     subsWithNA = TRUE)
  
  writeRaster(all_am_map, filename = all_am_rast_file, overwrite = TRUE)

} else {
  all_am_map   <- raster(all_am_rast_file)
}

levelplot(all_am_map, par.settings = myTheme, main = 'Entire Aquamaps Dataset')

all_am_ln_map <- log(all_am_map + 1)
all_am_ln_map <- all_am_ln_map/maxValue(all_am_ln_map)
levelplot(all_am_ln_map, par.settings = myTheme, main = 'Entire Aquamaps Dataset: log-transformed relative species richness', 
          colorkey = list(at = seq(0, 1, length = 15)))

am_ln_pts <- as.data.frame(rasterToPoints(all_am_ln_map))
spp_richness_am_plot <- ggplot(am_ln_pts, aes(x = x, y = y)) +
  ggtheme_map + 
  geom_raster(aes(fill = layer), alpha = .7) +
  scale_fill_continuous(low = 'white', high = 'blue') +
  borders('world', color='gray40', fill='gray45', size = .1) +  # create a layer of borders
  scale_x_continuous(breaks = seq(-180, 180, by = 30), expand = c(0, 2)) +
  scale_y_continuous(breaks = seq( -90,  90, by = 30), expand = c(0, 2)) +
  labs(title = 'AquaMaps Dataset: log-transformed relative species richness', x = NULL, y = NULL, fill = NULL) 

spp_richness_am_plot
ggsave(file.path(dir_fig, 'all_am_ln_map.png'), height = 4, width = 8)

```

Now look at full IUCN species

```{r all_aquamaps, eval = FALSE, echo = FALSE}

all_iucn_rast_file   <- 'rasters/iucn_all_rast.tif'

if(!file.exists(all_iucn_rast_file)) {
  iucn_cells_file    <- file.path(dir_data_iucn, 'iucn_cells_2015.csv')
  iucn_spp_cells_all <- fread(iucn_cells_file) %>%
        as.data.frame(stringsAsFactors = FALSE)
  
  ### find total spp to allow for percent calcs later
  # am_all_n_tot <- am_spp_cells_big %>% 
  #   dplyr::select(SpeciesID) %>% 
  #   unique() %>% nrow()
  
  all_iucn <- iucn_spp_cells_all %>%
    group_by(loiczid) %>%
    summarize(all_count = n()) %>%
  #   summarize(all_count = n(),
  #             all_pct   = all_count/am_all_n_tot) %>%
    as.data.frame()
  
  all_iucn_map <- subs(loiczid_raster, all_iucn[ , c('loiczid', 'all_count')], 
                     by = 'loiczid', 
                     which = 'all_count', 
                     subsWithNA = TRUE)
  
  writeRaster(all_iucn_map, filename = all_iucn_rast_file, overwrite = TRUE)

} else {
  all_iucn_map   <- raster(all_iucn_rast_file)
}

levelplot(all_iucn_map, par.settings = myTheme, main = 'Entire IUCN Dataset')

all_iucn_ln_map <- log(all_iucn_map + 1)
all_iucn_ln_map <- all_iucn_ln_map/maxValue(all_iucn_ln_map)
levelplot(all_iucn_ln_map, 
          par.settings = myTheme, 
          margin = list(axis = TRUE),
          main = 'Entire IUCN Dataset: log-transformed relative species richness', 
          colorkey = list(at = seq(0, 1, length = 15)))

iucn_ln_pts <- as.data.frame(rasterToPoints(all_iucn_ln_map))
spp_richness_iucn_plot <- ggplot(iucn_ln_pts, aes(x = x, y = y)) +
  ggtheme_map + 
  geom_raster(aes(fill = layer), alpha = .7) +
  scale_fill_continuous(low = 'white', high = 'blue') +
  borders('world', color='gray40', fill='gray45', size = .1) +  # create a layer of borders
  scale_x_continuous(breaks = seq(-180, 180, by = 30), expand = c(0, 2)) +
  scale_y_continuous(breaks = seq( -90,  90, by = 30), expand = c(0, 2)) +
  labs(title = 'IUCN Dataset: log-transformed relative species richness', x = NULL, y = NULL, fill = NULL) 

spp_richness_iucn_plot
ggsave(file.path(dir_fig, 'all_iucn_ln_map.png'), height = 4, width = 8)

```

![image](figures/all_aquamaps_map.png)

``` {r variations_on_gl_dist_maps, echo = FALSE, eval = FALSE}
### rescale values relative to maximum cell value

am_map_max <- maxValue(all_am_map)
all_am_pct_map <- all_am_map/am_map_max

iucn_map_max <- maxValue(all_iucn_map)
all_iucn_pct_map <- all_iucn_map/iucn_map_max

diff_pct_map    <- all_am_pct_map - all_iucn_pct_map

### plot maps with distributions as percentages.  Should it be 0 - 1, or 
### 0 - max value?
levelplot(all_am_pct_map, par.settings = myTheme, 
          main = 'Aquamaps Dataset percent of max')
levelplot(all_iucn_pct_map, par.settings = myTheme, 
          main = 'IUCN Dataset percent of max')
### this is the difference one. Should it be min value to max value?
levelplot(diff_pct_map, par.settings = myTheme, 
          main = 'Difference: AquaMaps - IUCN by percent')

diff_ln_map <- all_am_ln_map - all_iucn_ln_map
levelplot(diff_ln_map, 
          par.settings = myTheme, 
          pretty = TRUE,
          margin = list(axis = TRUE),
          main = 'Difference in relative species richness (log-transformed): AquaMaps - IUCN', 
          colorkey = list(at = seq(-1, 1, length = 15)))
maxValue(all_am_ln_map)
minValue(all_am_ln_map)
maxValue(all_iucn_ln_map)
minValue(all_iucn_ln_map)
maxValue(diff_ln_map)
minValue(diff_ln_map)
diff_ln_pts <- as.data.frame(rasterToPoints(diff_ln_map))

spp_richness_diff_plot <- ggplot(diff_ln_pts, aes(x = x, y = y)) +
  ggtheme_map + 
  geom_raster(aes(fill = layer)) +
  scale_fill_gradient2(low = 'red', mid = 'white', high = 'blue', midpoint = 0) +
  borders('world', color='gray40', fill='gray45', size = .1) +  # create a layer of borders
  scale_x_continuous(breaks = seq(-180, 180, by = 30), expand = c(0, 2)) +
  scale_y_continuous(breaks = seq( -90,  90, by = 30), expand = c(0, 2)) +
  labs(title = 'Difference in relative species richness (log-transformed): AquaMaps - IUCN', x = NULL, y = NULL) 

spp_richness_diff_plot


```
