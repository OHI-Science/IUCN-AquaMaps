###(1) Number of species in both datasets split up by group

``` {r}
spp_df <- spp_list %>%
  mutate(diff = iucn_area - am_area)

spp_df <- within(spp_df, spp_group <- factor(spp_group, levels = names(sort(table(spp_group), increasing = TRUE))))

```

```{r number of spp per group, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

### look at number of species per group

barchart_sp_groups <- ggplot(spp_df, aes(x = spp_group)) +
  ggtheme_plot + 
  geom_bar(stat = 'bin') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) + 
  coord_flip() +
  labs(x = 'Species Group', 
       y = 'Number of Species', 
       title = 'Number of species in both AquaMaps and IUCN datasets')

ggsave(file.path(dir_fig, 'sp_groups_barchart.png'), 
       plot = barchart_sp_groups, 
       width = 8, height = 4, dpi = 100)

print(barchart_sp_groups)

```

***  
  
###(2) Looking at the total difference in area (km^2^) for each species range map in both datasets

```{r area compare 1, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}

scatter_am_iucn_area <- ggplot(spp_df, aes(x = iucn_area, y = am_area, color = iucn_category)) + 
  ggtheme_plot + 
  geom_point() + 
  geom_abline(slope = 1, intercept = 0, color = 'red') +
  labs(x = 'Area (km^2) from IUCN dataset', 
       y = 'Area (km^2) from AquaMaps dataset', 
       title = 'Comparing total area of species range maps')

ggsave(file.path(dir_fig, 'CompareTotalArea_AM-IUCN_scatter.png'), 
       plot = scatter_am_iucn_area, 
       width = 8, height = 4, dpi = 100)

print(scatter_am_iucn_area)
```


There are large differences so to get a better sense, here is the same comparison but with area log transformed.
``` {r area compare log, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

spp_df <- spp_df %>%
  mutate(am_log = log(am_area),
         iucn_log = log(iucn_area))

scatter_am_iucn_area_log <- ggplot(spp_df, aes(iucn_log, am_log, color = iucn_category)) + 
  ggtheme_plot + 
  geom_point() + 
  geom_abline(slope = 1, intercept = 0, color = 'red') +
  labs(x = 'IUCN Area (log transformed)', 
       y = 'AquaMaps Area (log transformed)',
       title = 'Comparing area of range maps\n (all area values are km^2 log transformed)', 
       fill = 'IUCN Category')

ggsave(file.path(dir_fig, 'CompareTotalAreaLOG_AM-IUCN_scatter.png'), 
       plot = scatter_am_iucn_area_log, 
       width = 8, height = 4, dpi = 100)

print(scatter_am_iucn_area_log)
```

Data split into species groups and by IUCN category
```{r area compare by spp group, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

scatter_am_iucn_alog_gp <- ggplot(spp_df, aes(iucn_log, am_log, color = iucn_category)) + 
  ggtheme_plot + 
  geom_point() +
  facet_wrap(~spp_group) + 
  geom_abline() + 
  labs(x = 'IUCN Area (log transformed)', 
       y = 'AquaMaps Area (log transformed)',
       title = 'Comparing differences in area across species groups', 
       fill = 'IUCN Category')

ggsave(file.path(dir_fig, 'CompareTotalAreaLOG_AM-IUCN_spgroups_scatter.png'), 
       plot = scatter_am_iucn_alog_gp, 
       width = 8, height = 6, dpi = 100)

print(scatter_am_iucn_alog_gp)
```
***  
  
  ###(3) Looking at the overlap between species range maps from IUCN and AquaMaps  
  
  This plot shows the total percent of a species range map that is (1) only covered by IUCN cells, (2) only covered by AquaMaps cells and (3) covered by both IUCN and AquaMaps cells. 

####How this breaks down between AquaMaps and IUCN

Here is an example of a single species, the yellow speckled chromis (*Chromis alpha*)  

```{r map chromis alpha, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}

spp <- 'Chromis alpha'

spp_map <- plot_rangemap(spp)

print(spp_map)
ggsave(plot = spp_map,
       filename = file.path(dir_fig, sprintf('rangemap_%s.png', spp)),
       width = 8, height = 4, dpi = 200)
```


```{r, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}

spp_df2 <- gather(spp_list, perc.type, percent, perc, am_perc, iucn_perc) %>%
  dplyr::select(sciname, spp_group, perc.type, percent) %>%
  unique()

perc_c <- spp_df2 %>%
  filter(sciname == spp)

p1 <- perc_c %>% 
  dplyr::select(percent)


```

For `r spp`, `r round(pi[1], 2)`% of the total area is covered by both IUCN and AquaMaps, `r round(p1[2, ], 2)`% is covered just by AquaMaps and `r round(p1[3, ], 2)`% is covered just by IUCN.

***  
  
  #### Now looking across all species, here is the breakdown of how much overlap there is between the two datasets  
  
  This plot shows that the majority of species range maps have only ~30% of their full map covered by both maps, and very few species have more than 50% of their two ranges (IUCN and AquaMaps) overlapping. 


```{r hist overlap vs total range, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

### look at density plot

overlap <- spp_df2 %>%
  dplyr::filter(perc.type == 'perc')

hist_overlap_pct <- ggplot(overlap, aes(percent)) +
  ggtheme_plot + 
  geom_histogram(aes(y = ..count../1926), binwidth = 5, alpha = .8) +
  labs(title = 'Percent of total range shared between datasets',
       x = '% total range that is shared b/w both datasets', 
       y = 'Proportion of Total Species')

ggsave(file.path(dir_fig, 'Overlap-PercTotalRange.png'))

print(hist_overlap_pct)
```



Split up by species groups

```{r facet by spp, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}

hist_overlap_pct_gp <- ggplot(overlap, aes(percent)) + 
  ggtheme_plot + 
  geom_histogram(binwidth = 5, alpha = .8) +
  facet_wrap(~spp_group) +
  labs(title = 'Percent of total range shared, by species group',
       x = 'Percent of total range that is shared between both datasets', 
       y = 'Number of Total Species') + 
  theme(strip.text.x = element_text(size = 8))

ggsave(file.path(dir_fig, 'Overlap-PercTotalRange_spGroups.png'))
print(hist_overlap_pct_gp)

```
