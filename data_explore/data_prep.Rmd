---
title: 'Data Prep: IUCN and AquaMaps'
output: html_document
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}

# Libraries and Paths

library(readr)
library(data.table)
library(tidyr)
library(dplyr)
library(stringr)

dir_N <- c('Windows' = '//neptune.nceas.ucsb.edu/data_edit',
           'Darwin'  = '/Volumes/data_edit',
           'Linux'   = '/var/data/ohi')[[ Sys.info()[['sysname']] ]]

dir_git <- '~/github/IUCN-AquaMaps'
  
dir_anx <- file.path(dir_N, 'git-annex/globalprep/SPP_ICO')
dir_fig <- file.path(dir_git, 'figures')
dir_data <- file.path(dir_git, 'data')
dir_data_remote <- file.path(dir_N, 'git-annex/globalprep/_raw_data')

setwd('data_explore')
source('data_explore_fxns.R')
### When knitting this, it automatically sets WD to be this directory...
### the 'setwd()' is there for running by chunk
```

Need to:

gather spp_all, spp_am, spp_am_v_iucn, spp_list_w_area_all and _trimmed into data folder.


```{r get_spp_list, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}
### get spp_all_complete from git-annex, bring to local repo
spp_all_remote <- read.csv(file.path(dir_anx, 'v2016/int/spp_all_complete.csv'), stringsAsFactors = FALSE)
write.csv(spp_all_remote, file.path(dir_data, 'spp_all.csv'), row.names = FALSE)

### create spp_am_v_iucn
spp_am_v_iucn <- spp_all_remote %>%
  filter(str_detect(spatial_source, 'iucn') & !is.na(am_sid)) %>%
  unique()
write.csv(spp_am_v_iucn, file.path(dir_data, 'spp_am_v_iucn.csv'), row.names = FALSE)

```

```{r read_am_and_iucn_data, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}

# Data files
#iucn spp cells WITHOUT extinct locations of IUCN subpopulations
iucn_spp_cells <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/iucn_spp_cells_2015.csv'), 
                           col_types = 'cdddd', progress = TRUE) %>%
  as.data.frame() %>%
  filter(presence != 5) ### removes extinct subpopulations

am_spp_cells   <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/am_spp_cells_2015.csv'), progress = TRUE)

```

```{r get_spp_list, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}
data_file <- file.path(dir_data, 'spp_list_w_area_all.csv')
reload = TRUE
if (!file.exists(data_file) | reload) {
  ### species info list - scinames, IUCN species ID, AM species ID, category etc
  spp_list_base <- read.csv(file.path(dir_data, 'spp_am_v_iucn.csv'),
                            stringsAsFactors = FALSE)
  
  create_spp_list(spp_list_base, data_file)
}

spp_list <- read.csv(data_file, stringsAsFactors = FALSE) 
### At this point, spp_list contains subpops and aliases, and zero-area IUCNs

spp_list <- spp_list %>%
  filter(!is.na(sm_perc)) %>%
  ### will ditch the ones where no IUCN polygon exists - or are these species
  ### whose ranges only occur in cells beyond the LOICZID grid?
  filter(!str_detect(spatial_source, 'subpop') & !str_detect(spatial_source, 'alias'))
spp_list <- spp_list %>%
  left_join(read.csv(file.path(dir_data, 'sciname_lookups/spp_groupnames.csv'), 
                     stringsAsFactors = FALSE),
            by = 'spp_group')

write.csv(spp_list, file.path(dir_data, 'spp_list_w_area_trimmed.csv'))

```
