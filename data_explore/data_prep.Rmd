---
title: 'Data Prep: IUCN and AquaMaps'
output: html_document
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}

# Libraries and Paths

library(raster)
library(readr)
library(data.table)
library(ggplot2)
library(tidyr)
library(dplyr)
library(stringr)

dir_N <- c('Windows' = '//neptune.nceas.ucsb.edu/data_edit',
           'Darwin'  = '/Volumes/data_edit',
           'Linux'   = '/var/data/ohi')[[ Sys.info()[['sysname']] ]]

dir_git <- '~/github/IUCN-AquaMaps'
  
dir_anx <- file.path(dir_N, 'git-annex/globalprep/SPP_ICO')
dir_fig <- file.path(dir_git, 'figures')
dir_data <- file.path(dir_git, 'data')
dir_data_remote <- file.path(dir_N, 'git-annex/globalprep/_raw_data')
scenario <- 'v2016'

if(basename(getwd()) != 'data_explore') setwd('~/github/IUCN-AquaMaps/data_explore')
source('data_explore_fxns.R')
### When knitting this, it automatically sets WD to be this directory...
### the 'setwd()' is there for running by chunk
```

Need to:

gather spp_all, spp_am, spp_am_v_iucn, spp_list_w_area_all and _trimmed into data folder.

``` {r pull_files_to_local, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}
### pull spp_iucn_marine.csv from git-annex and bring to local repo
spp_iucn <- read.csv(file.path(dir_anx, scenario, 'int/spp_iucn_cleaned.csv'), 
                            stringsAsFactors = FALSE)
spp_iucn <- spp_iucn %>%
  dplyr::select(sciname, iucn_sid, iucn_category, 
                popn_trend, parent_sid, subpop_sid) %>%
  unique()
write_csv(spp_iucn, file.path(dir_data, 'spp_iucn.csv'))
          
### pull spp_iucn_maps_all.csv from git-annex and bring to local repo
spp_iucn_maps <- read.csv(file.path(dir_anx, scenario, 'int/spp_iucn_maps_all.csv'), 
                            stringsAsFactors = FALSE) %>%
  rename(iucn_sid = id_no)

spp_iucn_maps <- spp_iucn_maps %>%
  filter(!str_detect(spp_group, 'MARINEFISH')) %>%
  unique() %>%
  arrange(iucn_sid)

### At this point, still some duplicated iucn_sids, due to several
### names matching a single ID.  Not sure which names might be in
### AquaMaps though, so leave 'em in.

write_csv(spp_iucn_maps, file.path(dir_data, 'spp_iucn_maps.csv'))

### pull cleaned spp_am data from git-annex and bring to local repo
spp_am <- read.csv(file.path(dir_anx, scenario, 'int/spp_am_cleaned.csv'), 
                   stringsAsFactors = FALSE)
write_csv(spp_am, file.path(dir_data, 'spp_am.csv'))

### pull raw aquamaps species list from git-annex and bring to local repo
spp_am_raw <- read.csv(file.path(dir_data_remote, 'aquamaps/v2015/csv/speciesoccursum.csv'), 
                   stringsAsFactors = FALSE)
write_csv(spp_am_raw, file.path(dir_data, 'speciesoccursum.csv'))

```

```{r get_spp_all, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}
### get spp_all_complete from git-annex, bring to local repo.  The spp_all_complete
### file was created in ohiprep/globalprep/SPP_ICO/data_prep_SPP.R, running the
### function create_spp_master_lookup(source_pref = 'iucn', fn_tag = '_complete', reload = TRUE)
spp_all_remote <- read.csv(file.path(dir_anx, scenario, 'int/spp_all.csv'), 
                           stringsAsFactors = FALSE) 
spp_all_remote_clean <- spp_all_remote %>%
  filter(!str_detect(spatial_source, 'subpop')) %>%
  filter(!str_detect(spatial_source,  'alias'))
### At this point, plenty of duplicates:
### * This code returns 984 duplicated names:
###     length(spp_all_remote_clean$sciname) - length(unique(spp_all_remote_clean$sciname))
### * some are AM subpops which were ignored in processing the remote spp_all file.
###   Note: All subpops have an identified parent, so can filter them out without
###   losing any species.
###   code to verify this:
###     z_parent <- spp_all_remote_clean %>% 
###       filter(!is.na(subpop_sid) & spatial_source == 'am')
###     z_subpop <- spp_all_remote_clean %>% 
###       filter(!is.na(parent_sid) & spatial_source == 'am')
###     nrow(z_subpop %>% filter(!sciname %in% z_parent$sciname))
### * some are duplicated IUCN parents (e.g. Dermochelys coriacea) that will be 
###   eliminated when select(-iucn_subpop) column and then unique()

### filter out spatial_source == 'am' that also have parent_sid (i.e.
### these are AM-mapped subpopulations); then: 
### select away the iucn_subpop, parent_sid, and subpop_sid (among others),
### these are creating false unique rows.
spp_all <- spp_all_remote_clean %>%
  filter(!(spatial_source == 'am' & !is.na(parent_sid))) %>%
  dplyr::select(am_sid, sciname, reviewed, iucn_sid, popn_trend,
         popn_category, spp_group, id_no, spatial_source, name_verified) %>%
  unique()
### At this point, still some duped scinames - these are ones with multiple IUCN
### SIDs that are not designated as parents or subpops.  We will brute-force
### this by just eliminating the duplicated rows, keeping only the first instance.
### By arranging by iucn_sid, we will keep the lowest value, which seems to
### generally correspond to the parent...
spp_all <- spp_all %>%
  arrange(iucn_sid)
spp_all <- spp_all[!duplicated(spp_all$sciname), ]

length(spp_all$sciname) - length(unique(spp_all_remote_clean$sciname))
### no duped scinames - same length as original (cleaned) list

### But, some of the extracted IUCN maps don't appear on this list! add 'em in.
spp_iucn_maps_new <- read.csv(file.path(dir_data, 'spp_iucn_maps.csv'), 
                              stringsAsFactors = FALSE) %>%
  filter(!sciname %in% spp_all$sciname) %>%
  filter(!str_detect(sciname, 'subpop')) %>% ### a Hawaiian subpop... ditch it!
  select(-iucn_subpop)

spp_all1 <- spp_all %>%
  full_join(spp_iucn_maps_new)

### Also, some of the AM listings have disappeared due to name conflicts
### - aliases, etc.
spp_am_new <- read.csv(file.path(dir_data, 'speciesoccursum.csv'), 
                       stringsAsFactors = FALSE) %>%
  mutate(sciname = paste(str_trim(genus), str_trim(species)),
         iucn_sid = as.integer(iucn_id)) %>%
  dplyr::select(am_sid = speciesid, sciname, reviewed, iucn_sid,
                popn_category = iucn_code) %>%
  filter(!am_sid %in% spp_all$am_sid) %>%
  mutate(spatial_source = 'am',
         popn_category = ifelse(popn_category == 'LR/lc', 'LC', popn_category),
         popn_category = ifelse(popn_category == 'LR/nt', 'NT', popn_category),
         popn_category = ifelse(popn_category == 'N.E.',  'NE', popn_category))

### 545 new spp_am not in spp_all from remote source, by am_sid.
### 24 of these, however, list iucn_sids that match existing iucn_sid.
### * for species with iucn_sid that match, and no am_sid, add am_sid to 
###   existing record (use existing values for other fields; drop new values).
### * for species with iucn_sid that match, and with a different am_sid, no action.
### * for species with non-matching or NA iucn_sid, just add to list.
spp_am_new_iucnmatch <- spp_am_new %>% 
  filter(!is.na(iucn_sid) & iucn_sid %in% spp_all$iucn_sid) %>%
  dplyr::select(iucn_sid, am_sid_new = am_sid, reviewed_new = reviewed)
spp_all2 <- spp_all1 %>%
  left_join(spp_am_new_iucnmatch, by = 'iucn_sid') %>%
  mutate(am_sid   = ifelse(is.na(am_sid) & !is.na(am_sid_new), am_sid_new, am_sid),
         reviewed = ifelse(is.na(am_sid) & !is.na(am_sid_new), reviewed_new, reviewed)) %>%
  select(-am_sid_new, -reviewed_new)
spp_all3 <- spp_all2 %>%
  full_join(spp_am_new %>%
              filter(!iucn_sid %in% spp_am_new_iucnmatch$iucn_sid),
            by = c("am_sid", "sciname", "reviewed", "iucn_sid", "popn_category", "spatial_source"))

write_csv(spp_all3, file.path(dir_data, 'spp_all.csv'))

```

```{r get_other_vars, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}
### create spp_am_v_iucn: the whole maplist narrowed down to just the overlapping species.
### Overlaps detected from spatial_source containing 'iucn' (b/c source_pref = 'iucn' above),
### that also have a non-NA AquaMaps ID code.
spp_all <- read.csv(file.path(dir_data, 'spp_all.csv'), stringsAsFactors = FALSE)

spp_am_v_iucn <- spp_all %>%
  filter(str_detect(spatial_source, 'iucn') & !is.na(am_sid)) %>%
  filter(!is.na(id_no)) %>%
  unique()
# length(unique(spp_am_v_iucn$am_sid)); length(unique(spp_am_v_iucn$iucn_sid))
### NOTE: 2377 unique scientific names; but 2315 unique am_sid and 2280 unique iucn_sid.
x <- spp_am_v_iucn[duplicated(spp_am_v_iucn$am_sid)   | duplicated(spp_am_v_iucn$am_sid,   fromLast = TRUE), ] %>%
  select(sciname, iucn_sid, am_sid, id_no, spatial_source, name_verified)
y <- spp_am_v_iucn[duplicated(spp_am_v_iucn$iucn_sid) | duplicated(spp_am_v_iucn$iucn_sid, fromLast = TRUE), ] %>%
  select(sciname, iucn_sid, am_sid, id_no, spatial_source, name_verified)

write_csv(spp_am_v_iucn, file.path(dir_data, 'spp_am_v_iucn.csv'))
```

```{r read_am_and_iucn_data, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}

# Data files
#iucn spp cells WITHOUT extinct locations of IUCN subpopulations
iucn_spp_cells <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/iucn_spp_cells_2015.csv'), 
                           col_types = 'cdddd', progress = TRUE) %>%
  as.data.frame() %>%
  filter(presence != 5) ### removes extinct subpopulations

am_spp_cells   <- read_csv(file.path(dir_anx, 'explore_am_v_iucn/am_spp_cells_2015.csv'), progress = TRUE)

loiczid_raster_file  <- file.path(dir_git, 'shiny/data/loiczid_raster.grd')
loiczid_raster       <- raster(loiczid_raster_file)
names(loiczid_raster) <- 'loiczid'


```

```{r get_spp_list, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}
### Create files for species list with area info, both a complete list and a trimmed list


data_file <- file.path(dir_data, 'spp_list_w_area_all.csv')
reload <- TRUE
if (!file.exists(data_file) | reload) {
  ### species info list - scinames, IUCN species ID, AM species ID, category etc
  spp_list_base <- read.csv(file.path(dir_data, 'spp_am_v_iucn.csv'),
                            stringsAsFactors = FALSE)
  
  create_spp_list(spp_list_base, data_file, am_spp_cells, iucn_spp_cells, loiczid_raster)
}

spp_list <- read.csv(data_file, stringsAsFactors = FALSE) 
### At this point, spp_list zero-area IUCNs due to missing (?) polygons (maybe points?)

spp_am <- read.csv(file.path(dir_data, 'spp_am.csv'), stringsAsFactors = FALSE)

spp_list <- spp_list %>%
  mutate(sm_perc = ifelse(!is.na(sm_perc), 0, sm_perc))
  # filter(!is.na(sm_perc)) %>%
  ### will ditch the ones where no IUCN polygon exists - or are these species
  ### whose ranges only occur in cells beyond the LOICZID grid?
spp_list <- spp_list %>%
  left_join(read.csv(file.path(dir_data, 'sciname_lookups/spp_groupnames.csv'), 
                     stringsAsFactors = FALSE),
            by = 'spp_group') %>%
  left_join(spp_am %>% select(am_sid = speciesid, occurcells),
            by = 'am_sid')

write.csv(spp_list, file.path(dir_data, 'spp_list_w_area_trimmed.csv'), 
          row.names = FALSE)

```

``` {r get_counts, echo = FALSE}
x <- occ_search(scientificName = spp_iucn_marine$sciname[1:100], fields = 'minimal', limit = 25)
y <- sapply(x, function(x) x$meta$count)
```
