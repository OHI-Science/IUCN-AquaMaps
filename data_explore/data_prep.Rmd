---
title: 'Data Prep: IUCN and AquaMaps'
output: html_document
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}

# Libraries and Paths

library(raster)
library(readr)
library(data.table)
library(tidyr)
library(dplyr)
library(stringr)

dir_M <- c('Windows' = '//mazu.nceas.ucsb.edu/data_edit',
           'Darwin'  = '/Volumes/ohi',
           'Linux'   = '/var/data/ohi')[[ Sys.info()[['sysname']] ]]

dir_git <- '~/github/IUCN-AquaMaps'
  
dir_anx <- file.path(dir_M, 'git-annex/globalprep/spp_ico')
dir_fig <- file.path(dir_git, 'figures')
dir_data <- file.path(dir_git, 'data')
dir_data_remote <- file.path(dir_M, 'git-annex/globalprep/_raw_data')
scenario <- 'v2016'

if(basename(getwd()) != 'data_explore') setwd('~/github/IUCN-AquaMaps/data_explore')
source('data_explore_fxns.R')
### When knitting this, it automatically sets WD to be this directory...
### the 'setwd()' is there for running by chunk
```

```{r get_spp_all, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

spp_iucn_maps <- read_csv(file.path(dir_data, 'spp_iucn_maps.csv'))

spp_am_maps <- read_csv(file.path(dir_data, 'speciesoccursum.csv')) %>%
  mutate(sciname = paste(str_trim(genus), str_trim(species)),
         iucn_id = as.integer(iucn_id)) %>%
  dplyr::select(am_sid = speciesid, sciname, reviewed, iucn_id)

spp_all <- spp_iucn_maps %>%
  full_join(spp_am_maps, by = 'sciname') %>%
  distinct()

### some confusion due to non-matching scinames and IDs...
spp_all <- spp_all %>%
  mutate(iucn_match = iucn_sid == iucn_id,
         iucn_wrong_map = ifelse(!iucn_match & iucn_id %in% spp_all$iucn_sid, TRUE, FALSE)) %>%
  mutate(iucn_sid = ifelse(iucn_wrong_map & !is.na(iucn_wrong_map), iucn_id, iucn_sid)) %>%
  select(-iucn_match, -iucn_wrong_map, -iucn_id, -sciname_count) %>%
  distinct()


length(unique(x$iucn_sid)) ###  4013, incl NA
length(unique(x$am_sid))   ### 22890, incl NA

write_csv(spp_all, file.path(dir_data, 'spp_all_maps.csv'))

```

```{r get_other_vars, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}
### create spp_am_v_iucn: the whole maplist narrowed down to just the overlapping species.
### Overlaps detected from spatial_source containing 'iucn' (b/c source_pref = 'iucn' above),
### that also have a non-NA AquaMaps ID code.
spp_all <- read_csv(file.path(dir_data, 'spp_all_maps.csv'))

spp_am_v_iucn <- spp_all %>%
  select(-iucn_subpop) %>%
  filter(!is.na(iucn_sid) & !is.na(am_sid)) %>%
  unique()

# length(unique(spp_am_v_iucn$sciname)); length(unique(spp_am_v_iucn$am_sid)); length(unique(spp_am_v_iucn$iucn_sid))
### NOTE: 2314 unique scientific names; but 2314 unique am_sid and 2320 unique iucn_sid.
### Seasnakes are included in Reptiles (IUCN).  Two "mangroves" that are actually seagrasses.
spp_am_v_iucn <- spp_am_v_iucn %>%
  group_by(am_sid, iucn_sid) %>%
  mutate(dupes = n() - 1) %>%
  ungroup() %>%
  filter(!(dupes == 1 & spp_group == 'MANGROVES')) %>%
  filter(spp_group != 'SEASNAKES') %>%
  select(-dupes)
# length(unique(spp_am_v_iucn$sciname)); length(unique(spp_am_v_iucn$am_sid)); length(unique(spp_am_v_iucn$iucn_sid))

sciname_dupes <- spp_am_v_iucn %>%
  group_by(sciname) %>%
  filter(n() > 1)
### these seem to be spp with IUCN maps for synonyms.  Keep 'em in.


write_csv(spp_am_v_iucn, file.path(dir_data, 'spp_am_v_iucn.csv'))

```

```{r read_am_and_iucn_data, echo = FALSE, warning = FALSE, message = FALSE}

spp_am_v_iucn <- read_csv(file.path(dir_data, 'spp_am_v_iucn.csv'))

# Data files

# iucn_spp_cells_files <- list.files(file.path(dir_anx, 'v2016/iucn_intersections'), full.names = TRUE)
# iucn_spp_cells_all <- lapply(iucn_spp_cells_files, FUN = function(x) {
#   read_csv(x) %>% 
#     mutate(id_no = as.integer(id_no)) %>%
#     rename(iucn_sid = id_no)
#   }) %>%
#   bind_rows()
# 
# iucn_spp_cells <- iucn_spp_cells_all %>%
#   filter(iucn_sid %in% spp_am_v_iucn$iucn_sid) %>%
#   filter(presence != 5)

### length(unique(iucn_spp_cells$iucn_sid)) results in 2271 species found...
###   some species with no cells reported.  
### spp_missing <- spp_am_v_iucn %>% filter(!iucn_sid %in% iucn_spp_cells$iucn_sid)
###   49 spp with no cells reported.  Shapefile errors?
# write_csv(iucn_spp_cells, file.path(dir_anx, 'vAM_IUCN/iucn_spp_cells_2015.csv'))

message('Loading AquaMaps species to cell table.  This might take a few minutes.')
am_spp_cells_all <- fread(file.path(dir_data_remote, 'aquamaps/d2015/csv/hcaf_sp_native_trunc.csv'), 
                         showProgress = TRUE)
am_spp_cells <- am_spp_cells_all %>%
  rename(am_sid = speciesid, prob = probability) %>%
  filter(am_sid %in% spp_am_v_iucn$am_sid)
### length(unique(am_spp_cells$am_sid)) results in 2314 species found
write_csv(am_spp_cells, file.path(dir_anx, 'vAM_IUCN/am_spp_cells_2015.csv'))

```

```{r get_spp_list, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}
### Create files for species list with area info, both a complete list and a trimmed list

loiczid_raster_file  <- file.path(dir_git, 'shiny/data/loiczid_raster.grd')
loiczid_raster       <- raster::raster(loiczid_raster_file)
names(loiczid_raster) <- 'loiczid'

data_file <- file.path(dir_data, 'spp_list_w_area_all.csv')
reload <- FALSE
if (!file.exists(data_file) | reload) {

  if(!exists('am_spp_cells'))
    am_spp_cells <- read_csv(file.path(dir_anx, 'vAM_IUCN/am_spp_cells_2015.csv'))
  if(!exists('iucn_spp_cells'))
    iucn_spp_cells <- read_csv(file.path(dir_anx, 'vAM_IUCN/iucn_spp_cells_2015.csv'))
  
  ### species info list - scinames, IUCN species ID, AM species ID, category etc
  spp_list_base <- read_csv(file.path(dir_data, 'spp_am_v_iucn.csv'))
  
  create_spp_list(spp_list_base, data_file, am_spp_cells, iucn_spp_cells, loiczid_raster)
}

spp_list <- read_csv(data_file) 
### At this point, spp_list zero-area IUCNs due to missing (?) polygons (maybe points?)

spp_list <- spp_list %>%
  mutate(sm_perc = ifelse(is.na(sm_perc), 0, sm_perc)) %>%
  filter(!area_iucn == 0)
  ### will ditch the ones with no IUCN area - formerly caused by DD species
  ### being filtered out.  Now, none suffer this consequence.

### attach group name text field, and occurcells field
spp_list <- spp_list %>%
  left_join(x <- read_csv(file.path(dir_data, 'sciname_lookups/spp_groupnames.csv')),
            by = 'spp_group') %>%
  left_join(read_csv(file.path(dir_data_remote, 'aquamaps/v2015/csv/speciesoccursum.csv')) %>% 
              select(am_sid = speciesid, occurcells),
            by = 'am_sid')

cat_score_df <- data.frame(popn_category  = c('LC', 'NT', 'VU', 'EN', 'CR', 'EX', 'DD', 'NE'),
                           category_score = c( 0.0,  0.2,  0.4,  0.6,  0.8,  1.0,   NA,  NA))
spp_list <- spp_list %>%
  left_join(cat_score_df, by = 'popn_category')

write_csv(spp_list, file.path(dir_data, 'spp_list_w_area_trimmed.csv'))

```

``` {r counts_spp_all_observations, echo = FALSE}
spp_all <- read_csv(file.path(dir_data, 'spp_all.csv'))

# library(rgbif)

# system.time({
#   x <- occ_search(scientificName = spp_all$sciname[1:100], fields = 'minimal', limit = 1)
#   ### seems linear - 10 names ~ 2.5 sec, 100 names ~ 25 sec, 1000 names, ~250 sec
#   ### so 30000 names ~ 7500 sec or 2 hours
# })
# y <- sapply(x, function(x) x$meta$count)
# gbif_occur <- data.frame(sciname = names(y), gbif_occ = y)
# 
# gbif_occur <- gbif_occur %>% 
#   left_join(spp_all %>%
#               select(iucn_sid, am_sid, sciname),
#             by = 'sciname') %>%
#   left_join(read_csv(file.path(dir_data_remote, 'aquamaps/v2015/csv/speciesoccursum.csv')) %>%
#                        select(am_sid = speciesid, occurcells),
#                      by = 'am_sid')

# plot(ln_obs ~ ln_occurcells, data = gbif_occur)
# plot(obs ~ occurcells, data = gbif_occur)
# print(summary(lm(obs ~ occurcells, data = gbif_occur)))

# write_csv(gbif_occur, file.path(dir_data, 'gbif_occurrence.csv'))
gbif_occur <- read_csv(file.path(dir_data, 'gbif_occurrence.csv'))

# source('obis_count.R')
# scinames <- spp_all$sciname
# 
# obis_occur <- obis_count(scinames)
# obis_occur <- obis_count(scinames[26500:26600], verbose = TRUE)
# 
# obis_occur <- obis_occur %>% 
#   left_join(spp_all %>%
#               select(iucn_sid, am_sid, sciname),
#             by = 'sciname') %>%
#   left_join(read_csv(file.path(dir_data_remote, 'aquamaps/v2015/csv/speciesoccursum.csv')) %>%
#                        select(am_sid = speciesid, occurcells),
#                      by = 'am_sid')
# 
# write_csv(obis_occur, file.path(dir_data, 'obis_occurrence.csv'))
obis_occur <- read_csv(file.path(dir_data, 'obis_occurrence.csv'))

totes_occur <- obis_occur %>%
  left_join(gbif_occur) %>%
  rowwise() %>%
  mutate(mean_occ = mean(c(gbif_occ, obis_occ), na.rm = TRUE))

```

__Possible "data poor" indicators:__

* (of matched species) how does bottom decile get distributed across quadrants
* use mean of OBIS and GBIF, and just report average (or median?) occurrences across all species in each quadrant
* also use similar method for AM occurcells

``` {r data_poor_analysis, echo = FALSE, eval = FALSE}
spp_quads <- read_csv(file.path(dir_data, 'spp_list_quads.csv')) %>% 
  select(am_sid, iucn_sid, occurcells, quad) %>%
  unique()
### This contains all mapped species, discarding those with no actual IUCN maps

spp_occ_counts <- spp_quads %>%
  left_join(totes_occur) %>%
  group_by(iucn_sid, am_sid, quad) %>%
  summarize(occurcells = mean(occurcells, na.rm = TRUE), occ = mean(mean_occ, na.rm = TRUE)) %>%
  group_by(iucn_sid, quad) %>%
  summarize(occurcells = sum(occurcells, na.rm = TRUE), occ = sum(occ, na.rm = TRUE)) %>%
  ungroup()

btm_dec_occurcells <- spp_occ_counts$occurcells %>% quantile(c(.1, .25))
btm_dec_occ <- spp_occ_counts$occ %>% quantile(c(.1, .25))

quad_count_means <- spp_occ_counts %>%
  mutate(quad = ifelse(quad == 'q4', 'q4', 'q123')) %>%
  group_by(quad) %>%
  summarize(mean_occurcells = mean(occurcells),
            mean_occ        = mean(occ),
            med_occurcells  = median(occurcells),
            med_occ         = median(occ),
            dp_am_10 = sum(occurcells <= btm_dec_occurcells[1])/n(),
            dp_am_25 = sum(occurcells <= btm_dec_occurcells[2])/n(),
            dp_gb_10 = sum(occ <= btm_dec_occ[1])/n(),
            dp_gb_25 = sum(occ <= btm_dec_occ[2])/n())

write_csv(quad_count_means, file.path(dir_data, 'quads_data_poor.csv'))

```
