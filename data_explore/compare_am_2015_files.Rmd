---
title: "Comparing Aquamap 2015 csv files"
author: "Jamie Afflerbach"
date: "12/3/2015"
output: html_document
---

Since the 2015 Aquamaps dataset was sent as .sql files, we implemented two different methods of converting the .sql to .csvs. 

Casey wrote an R script to convert the files found here.

Jamie used the old method of MySQL to convert the files. A solution in R is preferred so this script compares the output of the two methods to make sure the R script produces what we want.

###Setup
```{r}

library(data.table)
library(dplyr)

dir_N <- c('Windows' = '//neptune.nceas.ucsb.edu/data_edit',
           'Darwin'  = '/Volumes/data_edit',
           'Linux'   = '/var/data/ohi')[[ Sys.info()[['sysname']] ]]

```

###Casey's data tables

```{r}

hcaf_native_co = read.csv(file.path(dir_N,'git-annex/globalprep/_raw_data/aquamaps/v2015/csv/hcaf_sp_native_trunc.csv'))
hcaf_co        = read.csv(file.path(dir_N,'git-annex/globalprep/_raw_data/aquamaps/v2015/csv/hcaf_truncated.csv'))
spp_co         = read.csv(file.path(dir_N,'git-annex/globalprep/_raw_data/aquamaps/v2015/csv/speciesoccursum.csv'))
```


###Jamie's data tables


```{r}

hcaf_native_ja = fread(file.path(dir_N,'git-annex/globalprep/_raw_data/aquamaps/v2015/tables/hcaf_species_native_ohi.csv'))%>%as.data.frame()
hcaf_ja        = read.csv(file.path(dir_N,'git-annex/globalprep/_raw_data/aquamaps/v2015/tables/hcaf_ohi.csv'))
spp_ja         = read.csv(file.path(dir_N,'git-annex/globalprep/_raw_data/aquamaps/v2015/tables/speciesoccursum_ohi.csv'))
```


##Comparison

```{r}

# First look at species list

nrow(spp_ja)-nrow(spp_co)

setdiff(spp_ja$SPECIESID,spp_co$speciesid)
setdiff(spp_co$speciesid,spp_ja$SPECIESID)
setdiff(spp_ja$Species,spp_co$species)

# Looks like no differences

# Look at cells files

nrow(spp_ja)-nrow(spp_co)

setdiff(hcaf_ja$CsquareCode,hcaf_co$csquarecode)
setdiff(hcaf_co$csquarecode,hcaf_ja$CsquareCode)

#looks like no differences

nrow(hcaf_native_ja) - nrow(hcaf_native_co)

setdiff(unique(hcaf_native_ja$SpeciesID),unique(hcaf_native_co$speciesid))
setdiff(unique(hcaf_native_co$speciesid),unique(hcaf_native_ja$SpeciesID))

#look at number of cells per species

h = hcaf_native_ja%>%group_by(SpeciesID)%>%summarize(count=n())%>%rename(speciesid=SpeciesID)%>%as.data.frame()
k = hcaf_native_co%>%group_by(speciesid)%>%summarize(count=n())%>%as.data.frame()%>%mutate(speciesid=as.character(speciesid))

setdiff(h,k)
setdiff(k,h)

#seems like just one species is causing the difference
f = filter(hcaf_native_co, speciesid=='Fis-32347')%>% #grab only rows with this species from Caseys data
            mutate(speciesid=as.character(speciesid))
g = filter(hcaf_native_ja, SpeciesID=='Fis-32347')%>%
     left_join(hcaf_co, by = c('CsquareCode' = 'csquarecode'))%>%
        select(speciesid = SpeciesID,probability,loiczid)

setdiff(g,f)

f = mutate(f,dup = duplicated(f))
filter(f,dup==TRUE)

#There are 6 cells that are duplicated for some reason....

filter(f,loiczid==150423)
filter(f,loiczid==150424)

filter(g,loiczid==150423) # but in the data that Casey created using R, he got rid of the duplicates

```


###Conclusion

It looks like there are 6 cells that are duplicated for Species ID **Fis-32347** (Bluntsnout lanternfish). This came from the raw Aquamaps dataset so Casey's version is just fine to work with!
